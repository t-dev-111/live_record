<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãƒ¡ã‚¿ã‚¿ã‚°ï¼ˆæ›´æ–°ãŒåæ˜ ã•ã‚Œãªã„å•é¡Œã‚’é˜²ãï¼‰ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ–è¨˜éŒ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    </style>
</head>
<body class="min-h-screen">

<header class="bg-gray-800 text-white shadow-lg sticky top-0 z-10">
    <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
        <h1 class="text-2xl font-extrabold tracking-tight">ğŸ¶ My Live Records</h1>
        <div class="flex space-x-3">
            <button id="toggleAddForm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-colors text-sm">äºˆå®šã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</button>
            <button id="toggleFilter" class="p-2 rounded-lg hover:bg-gray-700 transition-colors md:hidden text-sm">çµã‚Šè¾¼ã¿</button>
        </div>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4">

    <div id="addRecordSection" class="bg-white p-4 rounded-xl shadow-2xl mb-6 hidden border-l-4 border-blue-500">
        <h2 class="text-xl font-bold text-gray-800 mb-4">è¨˜éŒ²ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</h2>

        <div id="authArea">
            <p class="text-sm text-gray-500 mb-3 font-medium">â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã‚ˆã‚Šã€äºˆå®šã®è¿½åŠ ãƒ»ç·¨é›†ãŒå¯èƒ½ã§ã™ã€‚</p>
            <div class="flex space-x-2">
                <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="authenticateBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-5 rounded-lg transition-colors">èªè¨¼</button>
            </div>
            <p id="authMessage" class="mt-2 text-sm text-red-500"></p>
        </div>

        <form id="addRecordForm" class="hidden mt-4">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒª *</label>
                <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center cursor-pointer"><input type="radio" name="newType" value="live" checked class="form-radio text-blue-600 h-5 w-5"><span class="ml-2 text-gray-800 font-bold">ğŸ¤ ãƒ©ã‚¤ãƒ–</span></label>
                    <label class="inline-flex items-center cursor-pointer"><input type="radio" name="newType" value="event" class="form-radio text-orange-500 h-5 w-5"><span class="ml-2 text-gray-800 font-bold">ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</span></label>
                    <label class="inline-flex items-center cursor-pointer"><input type="radio" name="newType" value="other" class="form-radio text-green-500 h-5 w-5"><span class="ml-2 text-gray-800 font-bold">ğŸ¸ ãã®ä»–</span></label>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="newDate" class="block text-sm font-medium text-gray-700">æ—¥ä»˜ *</label>
                    <input type="date" id="newDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="newLiveName" class="block text-sm font-medium text-gray-700">ã‚¿ã‚¤ãƒˆãƒ« (ãƒ©ã‚¤ãƒ–/ã‚¤ãƒ™ãƒ³ãƒˆå) *</label>
                    <input type="text" id="newLiveName" placeholder="ä¾‹: Channel U Tour 2025" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="newArtist" class="block text-sm font-medium text-gray-700">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ/å‡ºæ¼”è€… *</label>
                    <input type="text" id="newArtist" placeholder="ä¾‹: ç·‘é»„è‰²ç¤¾ä¼š" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="newVenue" class="block text-sm font-medium text-gray-700">ä¼šå ´å *</label>
                    <input type="text" id="newVenue" placeholder="ä¾‹: æ°´æˆ¸å¸‚æ°‘ä¼šé¤¨" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="newSeatType" class="block text-sm font-medium text-gray-700">åº§å¸­/æ•´ç†ç•ªå· (ä»»æ„)</label>
                    <input type="text" id="newSeatType" placeholder="ä¾‹: 1éš 15åˆ— 11ç•ª" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="newTicketImageFile" class="block text-sm font-medium text-gray-700">ãƒã‚±ãƒƒãƒˆç”»åƒ (ä»»æ„)</label>
                    <input type="file" id="newTicketImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="newImageFile" class="block text-sm font-medium text-gray-700">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (ä»»æ„)</label>
                    <input type="file" id="newImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="mb-6" id="addSetlistArea"></div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">äºˆå®šã‚’ç™»éŒ²</button>
            <p id="addMessage" class="mt-2 text-sm text-green-600"></p>
        </form>
    </div>

    <div id="filterArea" class="bg-white p-4 rounded-xl shadow-md mb-6 md:block">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">è¨˜éŒ²ã‚’æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <input type="text" id="searchKeyword" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã€ä¼šå ´ã€å¸­ç¨®ã€æ¥½æ›²åã§æ¤œç´¢" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <select id="filterVenue" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"><option value="">å…¨ã¦ã®ä¼šå ´</option></select>
        </div>
    </div>

    <h2 id="upcomingTitle" class="text-2xl font-bold text-gray-700 mb-4 mt-6 border-b-2 border-blue-500 pb-1">ğŸ“… Upcoming Schedule</h2>
    <section id="upcomingList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></section>

    <h2 id="pastTitle" class="text-2xl font-bold text-gray-700 mb-4 mt-10 border-b-2 border-gray-400 pb-1">ğŸ¤ Past Schedule</h2>
    <section id="pastList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></section>

    <div id="noResults" class="hidden text-center p-12 bg-white rounded-xl shadow-md mt-6">
        <p class="text-xl text-gray-500 font-medium">ãŠæ¢ã—ã®è¨˜éŒ²ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
        <p class="text-gray-400 mt-2">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
    </div>
</main>

<div id="detailModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300" onclick="closeModal(event)">
    <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl overflow-y-auto transform scale-95 opacity-0 transition-all duration-300" role="dialog" aria-modal="true" aria-labelledby="modalTitle" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <div id="editButtons" class="space-x-2"></div>
                <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <div id="modalContent"></div>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[60] flex items-center justify-center p-4 hidden">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl">
        <h3 class="text-xl font-bold text-red-600 mb-4">ğŸš¨ è¨˜éŒ²ã®å‰Šé™¤ç¢ºèª</h3>
        <p class="mb-6 text-gray-700">æœ¬å½“ã«ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸€åº¦å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">å‰Šé™¤ã™ã‚‹</button>
        </div>
    </div>
</div>

<!-- Firebase CDN (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// --- Firebase è¨­å®šï¼ˆæä¾›ã„ãŸã ã„ãŸå€¤ï¼‰ ---
const firebaseConfig = {
  apiKey: "AIzaSyBDA4-gNmZzTdUkGQdDhesr2-yP9cfdHMw",
  authDomain: "livememo-219c5.firebaseapp.com",
  projectId: "livememo-219c5",
  storageBucket: "livememo-219c5.firebasestorage.app",
  messagingSenderId: "430429863654",
  appId: "1:430429863654:web:45002f94171dd95d4ac527",
  measurementId: "G-JKQBLYY5JP"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨èªè¨¼ç”¨ã®å®šæ•° ---
const CORRECT_PASSWORD_HASH = 'eb28853c3f343b83dbca201d27050f6d873b3da473aad7eeecd8f50722461861';
const MAX_ATTEMPTS = 20;
const LOCKOUT_DURATION_MS = 30 * 60 * 1000; // 30åˆ†
let isAuthSuccessful = false;

async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

function checkLockout() {
    const lockoutEnd = localStorage.getItem('lockoutEnd');
    const attempts = parseInt(localStorage.getItem('authAttempts') || '0');
    const now = Date.now();
    if (lockoutEnd && parseInt(lockoutEnd) > now) {
        const remaining = Math.ceil((parseInt(lockoutEnd) - now) / 60000);
        if(authMessage) {
            authMessage.textContent = `èªè¨¼ã«å¤±æ•—ã—ã™ããŸãŸã‚ã€æ®‹ã‚Š ${remaining} åˆ†é–“ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
            authMessage.className = "mt-2 text-sm text-red-600 font-bold";
        }
        if(authenticateBtn) authenticateBtn.disabled = true;
        if(passwordInput) passwordInput.disabled = true;
        return true;
    } else if (attempts >= MAX_ATTEMPTS) {
        localStorage.removeItem('authAttempts');
        localStorage.removeItem('lockoutEnd');
    }
    if(authenticateBtn) authenticateBtn.disabled = false;
    if(passwordInput) passwordInput.disabled = false;
    return false;
}

// --- åˆæœŸãƒ‡ãƒ¼ã‚¿ ï¼ˆlocal é–‹ç™ºç”¨ï¼‰ ---
const initialRecords = [
    { id: '1', type: "live", date: "2022-05-01", liveName: "Actor Tour 2022", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "ç¦å²¡ã‚µãƒ³ãƒ‘ãƒ¬ã‚¹", image: "", ticketImage: "", seatType: "1éš 10åˆ— 1ç•ª", setlist: [ {type:'song', title:'Actor'}, {type:'song', title:'LITMUS'}, {type:'song', title:'Mela!'}, {type:'song', title:'Shout Baby'}, {type:'song', title:'S.T.A.R.'} ] },
    { id: '2', type: "live", date: "2022-11-27", liveName: "LIVE TOUR 2022 Labo.", artist: "Snow man", venue: "ãƒãƒªãƒ³ãƒ¡ãƒƒã‚»ç¦å²¡", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ Aãƒ–ãƒ­ãƒƒã‚¯ 10ç•ª", setlist: [ {type:'song', title:'D.D.'}, {type:'song', title:'ãƒ–ãƒ©ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒˆ'}, {type:'song', title:'ã‚ªãƒ¬ãƒ³ã‚¸kiss'}, {type:'song', title:'JUICY'}, {type:'song', title:'Secret Touch'} ] },
    { id: '3', type: "live", date: "2023-06-10", liveName: "pink blue tour 2023", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "ç¦å²¡ã‚µãƒ³ãƒ‘ãƒ¬ã‚¹", image: "", ticketImage: "", seatType: "2éš 1åˆ— 20ç•ª", setlist: [ {type:'song', title:'ã‚µãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©'}, {type:'song', title:'å§‹ã¾ã‚Šã®æ­Œ'}, {type:'song', title:'Sabotage'}, {type:'song', title:'ä¸€æ­©'}, {type:'song', title:'èŠ±ã«ãªã£ã¦'} ] },
    { id: '4', type: "live", date: "2024-03-09", liveName: "LIVE TOUR VVS", artist: "SixTONES", venue: "ç¦å²¡paypayãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ã‚¹ã‚¿ãƒ³ãƒ‰ 5å¡å´ 10é€šè·¯", setlist: [ {type:'song', title:'ã“ã£ã‹ã‚‰'}, {type:'song', title:'NAVIGATOR'}, {type:'song', title:'Imitation Rain'}, {type:'song', title:'NEW ERA'}, {type:'song', title:'Good Luck!'} ] },
    { id: '5', type: "live", date: "2024-03-30", liveName: "Arena Tour 2024 Gates+", artist: "ç¾å°‘å¹´", venue: "æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "ã‚»ãƒ³ã‚¿ãƒ¼å¸­ 10ãƒ–ãƒ­ãƒƒã‚¯ 1ç•ª", setlist: [ {type:'song', title:'æœªæ¥ãŒå§‹ã¾ã‚‹'}, {type:'song', title:'Cosmic Melody'}, {type:'song', title:'Beautiful Love'}, {type:'song', title:'LALA LOVE'}, {type:'song', title:'è™¹ã®ä¸­ã§'} ] },
    { id: '6', type: "live", date: "2024-06-16", liveName: "ç·‘é»„è‰²ç¤¾ä¼šå¤§å¤œç¥­", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠå¸­ 5åˆ— 5ç•ª", setlist: [ {type:'song', title:'æ‹ã‚’ã—ã‚ˆã†'}, {type:'song', title:'Re'}, {type:'song', title:'Party!!'}, {type:'song', title:'ã«ã¡ã‚ˆã†ã³'}, {type:'song', title:'ã‚ã®é ƒã®æ­Œ'} ] },
    { id: '7', type: "live", date: "2024-11-10", liveName: "YOASOBI DOME LIVE 2024", artist: "YOASOBI", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ãƒãƒ«ã‚³ãƒ‹ãƒ¼å¸­ 1åˆ— 1ç•ª", setlist: [ {type:'song', title:'ã‚¢ã‚¤ãƒ‰ãƒ«'}, {type:'song', title:'å¤œã«é§†ã‘ã‚‹'}, {type:'song', title:'ç¾¤é’'}, {type:'song', title:'ç¥ç¦'}, {type:'song', title:'å‹‡è€…'} ] },
    { id: '8', type: "live", date: "2024-11-23", liveName: "LIVE HOUSE TOUR Laugh", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "Zepp Haneda", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '9', type: "live", date: "2024-12-15", liveName: "Snow Man Dome Tour 2024 RAVS", artist: "Snow Man", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ", setlist: [] },
    { id: '10', type: "live", date: "2025-04-04", liveName: "CENTRAL STAGE", artist: "ç·‘é»„è‰²ç¤¾ä¼š/ä¹ƒæœ¨å‚46", venue: "Kã‚¢ãƒªãƒ¼ãƒŠæ¨ªæµœ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ", setlist: [] },
    { id: '11', type: "event", date: "2025-04-06", liveName: "Echoes Baa", artist: "YOASOBI/FRUITS ZIPPER etc", venue: "æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '12', type: "live", date: "2025-05-02", liveName: "Channel U Tour 2025", artist: "FRUITS ZIPPER", venue: "æ°´æˆ¸å¸‚æ°‘ä¼šé¤¨", image: "", ticketImage: "", seatType: "1éš 15åˆ— 11ç•ª", setlist: [] },
    { id: '13', type: "live", date: "2025-07-05", liveName: "Channel Me", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "æ±äº¬ä½“è‚²é¤¨", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '14', type: "event", date: "2025-07-20", liveName: "ASOBI EXPO", artist: "ãã‚ƒã‚Šãƒ¼ã±ã¿ã‚…ã±ã¿ã‚…/æ–°ã—ã„å­¦æ ¡ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚º/FRUITS ZIPPER etc", venue: "å¹•å¼µãƒ¡ãƒƒã‚»å›½éš›å±•ç¤ºå ´", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '15', type: "live", date: "2025-08-02", liveName: "FRUITS ZIPPER 3rd ANNIVERSARY", artist: "FRUITS ZIPPER", venue: "ã•ã„ãŸã¾ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "200ãƒ¬ãƒ™ãƒ« 2åˆ— 333ç•ª", setlist: [] },
    { id: '16', type: "live", date: "2025-08-30", liveName: "è¶…ã¨ãã‚ãâ™¡å®£ä¼éƒ¨ã®ãã¿ã®ãƒãƒ¼ãƒˆã«ãƒ­ãƒƒã‚¯ã‚ªãƒ³TOUR 2025", artist: "è¶…ã¨ãã‚ãâ™¡å®£ä¼éƒ¨", venue: "ãƒ‘ã‚·ãƒ•ã‚£ã‚³æ¨ªæµœå›½ç«‹å¤§ãƒ›ãƒ¼ãƒ«", image: "", ticketImage: "", seatType: "2éšé€šè·¯ç·šå´", setlist: [] },
    { id: '17', type: "event", date: "2025-09-19", liveName: "éŸ³æ¥½ã®æ—¥ãƒ•ã‚§ã‚¹", artist: "FRUITS ZIPPER/CANDY TUNE/SWEET STEADY", venue: "æ±äº¬ã‚¬ãƒ¼ãƒ‡ãƒ³ã‚·ã‚¢ã‚¿ãƒ¼", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ 3åˆ— 10ç•ª", setlist: [] },
    { id: '18', type: "live", date: "2025-10-04", liveName: "ã¯ã¡ã‚ƒã‚ã¡ã‚ƒã‚ã¡ã‚ƒã‚ã¡ã‚ƒãƒ©ã‚¤ãƒ–", artist: "FRUITS ZIPPER", venue: "è±Šæ´²PIT 8ãƒ›ãƒ¼ãƒ«", image: "", ticketImage: "", seatType: "C1ãƒ–ãƒ­ãƒƒã‚¯åˆ—2ç•ªï¼ˆç«¯ï¼‰", setlist: [] },
    { id: '19', type: "live", date: "2025-10-07", liveName: "COSMIC CIRCUS", artist: "ç·‘é»„è‰²ç¤¾ä¼š/Aqua Timez", venue: "Zeppç¾½ç”°", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '20', type: "live", date: "2025-10-13", liveName: "CUTIE STREET 1st ANNIVERSARY", artist: "CUTIE STREET", venue: "ã´ã‚ã‚¢ãƒªãƒ¼ãƒŠMM", image: "", ticketImage: "https://placehold.co/100x100/e5e7eb/737373?text=Ticket", seatType: "ã‚¢ãƒªãƒ¼ãƒŠCãƒ–ãƒ­ãƒƒã‚¯ 4åˆ— 6ç•ª", setlist: [] },
    { id: '21', type: "live", date: "2025-11-17", liveName: "SWEET STEADY JAPAN TOUR 2025", artist: "SWEET STEADY", venue: "Zepp DiverCity", image: "", ticketImage: "https://placehold.co/100x100/e5e7eb/737373?text=Ticket", seatType: "", setlist: [] },
    { id: '22', type: "event", date: "2025-12-13", liveName: "KAWAII.LAB SESSION", artist: "FRUITS ZIPPER/CANDY TUNE/SWEET STEADY/CUTIE STREET", venue: "Kã‚¢ãƒªãƒ¼ãƒŠæ¨ªæµœ", image: "", ticketImage: "", seatType: "", setlist: [] },
    { id: '23', type: "live", date: "2026-02-04", liveName: "FRUITS ZIPPER SPECIAL LIVE 2026", artist: "FRUITS ZIPPER", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "", setlist: [] },
];
let liveRecords = [];
let unsubscribe = null; // snapshot listener

// HTML è¦ç´ å‚ç…§
const upcomingList = document.getElementById('upcomingList');
const pastList = document.getElementById('pastList');
const searchKeyword = document.getElementById('searchKeyword');
const filterVenue = document.getElementById('filterVenue');
const detailModal = document.getElementById('detailModal');
const modalContent = document.getElementById('modalContent');
const editButtons = document.getElementById('editButtons');
const deleteConfirmModal = document.getElementById('deleteConfirmModal');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const toggleAddFormBtn = document.getElementById('toggleAddForm');
const addRecordSection = document.getElementById('addRecordSection');
const addRecordForm = document.getElementById('addRecordForm');
const addMessage = document.getElementById('addMessage');
const addSetlistArea = document.getElementById('addSetlistArea');
const authArea = document.getElementById('authArea');
const passwordInput = document.getElementById('passwordInput');
const authenticateBtn = document.getElementById('authenticateBtn');
const authMessage = document.getElementById('authMessage');
const toggleFilterBtn = document.getElementById('toggleFilter');
const filterArea = document.getElementById('filterArea');
let recordToDeleteId = null;

// --- Firestore ãƒªã‚¹ãƒŠãƒ¼ã§å¸¸ã«åŒæœŸ ---
function startRealtimeListener() {
    if (unsubscribe) unsubscribe();
    unsubscribe = db.collection('liveRecords').orderBy('date').onSnapshot(snapshot => {
        liveRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateVenueFilter();
        filterRecords();
    }, err => console.error('snapshot error', err));
}

// --- åˆå›ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã®å ´åˆï¼‰ ---
async function seedIfEmpty() {
    const snapshot = await db.collection('liveRecords').limit(1).get();
    if (snapshot.empty) {
        const batch = db.batch();
        initialRecords.forEach(rec => {
            const ref = db.collection('liveRecords').doc(rec.id);
            batch.set(ref, rec);
        });
        await batch.commit();
    }
}

// --- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
async function uploadImageFile(file) {
    if (!file) return '';
    const path = `images/${Date.now()}_${file.name}`;
    const ref = storage.ref().child(path);
    await ref.put(file);
    return await ref.getDownloadURL();
}

// --- ãƒ¬ã‚³ãƒ¼ãƒ‰æ“ä½œ ---
async function addRecordToFirestore(record) {
    // let Firestore auto-generate id for simplicity
    const docRef = await db.collection('liveRecords').add(record);
    return docRef.id;
}

async function updateRecordInFirestore(id, record) {
    return db.collection('liveRecords').doc(String(id)).set(record, { merge: true });
}

async function deleteRecordFromFirestore(id) {
    return db.collection('liveRecords').doc(String(id)).delete();
}

// --- ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ç­‰ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿ï¼‰ ---
const renderSetlistEditor = (setlist, mode) => {
    const containerId = `${mode}SetlistEditorContainer`;
    const inputId = `${mode}NewSongInput`;
    const customSectionInputId = `${mode}NewSectionInput`;

    const itemsHtml = setlist.map((item, index) => {
        if (item.type === 'section') {
            return `\n<div class="flex items-center space-x-2 mb-2 setlist-item">\n<span class="text-gray-400 font-bold w-6 text-right">-</span>\n<input type="text" value="${item.title}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input font-bold text-blue-600">\n<button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">âœ–</button>\n</div>`;
        } else {
            return `\n<div class="flex items-center space-x-2 mb-2 setlist-item">\n<span class="text-gray-400 font-bold w-6 text-right">${index+1}.</span>\n<input type="text" value="${item.title}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input">\n<button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">âœ–</button>\n</div>`;
        }
    }).join('');

    return `\n<div class="bg-gray-50 p-4 rounded-lg border border-gray-200">\n<label class="block text-sm font-medium text-gray-700 mb-2">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ / ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ãƒ¡ãƒ¢</label>\n<div id="${containerId}">\n${itemsHtml}\n</div>\n<div class="flex mt-3 space-x-2 border-b pb-3 border-gray-200">\n<input type="text" id="${inputId}" placeholder="æ›²åã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" onkeydown="if(event.key==='Enter'){event.preventDefault(); addSetlistItem('${mode}');}">\n<button type="button" onclick="addSetlistItem('${mode}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors whitespace-nowrap">è¿½åŠ </button>\n</div>\n<div class="mt-3">\n<p class="text-xs text-gray-500 mb-2 font-bold">åŒºåˆ‡ã‚Šï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’è¿½åŠ :</p>\n<div class="flex flex-wrap gap-2 mb-2">\n<button type="button" onclick="addSection('${mode}', 'è¡£è£…æ›¿ãˆ')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm">è¡£è£…æ›¿ãˆ</button>\n<button type="button" onclick="addSection('${mode}', 'ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«</button>\n<button type="button" onclick="addSection('${mode}', 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">ãƒ¡ãƒ‰ãƒ¬ãƒ¼</button>\n<button type="button" onclick="addSection('${mode}', 'ãƒˆãƒ¼ã‚¯ã‚³ãƒ¼ãƒŠãƒ¼')" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded text-sm">ãƒˆãƒ¼ã‚¯</button>\n</div>\n<div class="flex space-x-2">\n<input type="text" id="${customSectionInputId}" placeholder="è‡ªç”±ãªåŒºåˆ‡ã‚Šå (ä¾‹: ç¬¬2éƒ¨, æŠ½é¸ä¼š)" class="flex-grow p-2 border border-gray-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500" onkeydown="if(event.key==='Enter'){event.preventDefault(); addCustomSection('${mode}');}">\n<button type="button" onclick="addCustomSection('${mode}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm whitespace-nowrap">è¿½åŠ </button>\n</div>\n</div>\n</div>`;
};

window.addSetlistItem = (mode) => {
    const containerId = `${mode}SetlistEditorContainer`;
    const inputId = `${mode}NewSongInput`;
    const input = document.getElementById(inputId);
    const songName = input.value.trim();
    if (!songName) return;
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2 mb-2 setlist-item';
    div.innerHTML = `\n<span class="text-gray-400 font-bold w-6 text-right">-</span>\n<input type="text" value="${songName}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input">\n<button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">âœ–</button>`;
    container.appendChild(div);
    input.value = '';
    input.focus();
    renumberSetlist(containerId);
};

window.addSection = (mode, title) => {
    const containerId = `${mode}SetlistEditorContainer`;
    const container = document.getElementById(containerId);
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2 mb-2 setlist-item';
    div.innerHTML = `\n<span class="text-gray-400 font-bold w-6 text-right">-</span>\n<input type="text" value="${title}" class="flex-grow p-2 border border-gray-300 rounded setlist-song-input font-bold text-blue-600">\n<button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">âœ–</button>`;
    container.appendChild(div);
    renumberSetlist(containerId);
};

window.addCustomSection = (mode) => {
    const inputId = `${mode}NewSectionInput`;
    const input = document.getElementById(inputId);
    const title = input.value.trim();
    if (!title) return;
    addSection(mode, title);
    input.value = '';
};

window.removeSetlistItem = (btn, containerId) => {
    const item = btn.closest('.setlist-item');
    item.remove();
    renumberSetlist(containerId);
};

const renumberSetlist = (containerId) => {
    const container = document.getElementById(containerId);
    const items = container.querySelectorAll('.setlist-item');
    let songIndex = 0;
    items.forEach((item) => {
        const numSpan = item.querySelector('span');
        const input = item.querySelector('.setlist-song-input');
        if (!numSpan || !input) return;
        const isSection = input.classList.contains('font-bold');
        if (isSection) { numSpan.textContent = '-'; }
        else { songIndex++; numSpan.textContent = `${songIndex}.`; }
    });
};

// --- è©³ç´°è¡¨ç¤ºãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
const renderDetailContent = (record, isEditMode = false) => {
    let typeLabel = 'ãƒ©ã‚¤ãƒ–'; if (record.type === 'event') typeLabel = 'ã‚¤ãƒ™ãƒ³ãƒˆ'; if (record.type === 'other') typeLabel = 'ãã®ä»–';
    if (isEditMode) {
        modalContent.innerHTML = `...`; // ç°¡æ½”åŒ–ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å‹•çš„ã«ç”Ÿæˆï¼‰
        // å®Ÿè£…æ¸ˆã¿ã®ç·¨é›†ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ openModal å†…ã§å·®ã—æ›¿ãˆã¾ã™ã€‚
    } else {
        const isUpcoming = new Date(record.date) >= new Date(new Date().setHours(0,0,0,0));
        let badge = record.type === 'event' ? `<span class="bg-orange-100 text-orange-800 text-sm font-bold px-2 py-1 rounded-md mr-2">ğŸª EVENT</span>` : record.type === 'other' ? `<span class="bg-green-100 text-green-800 text-sm font-bold px-2 py-1 rounded-md mr-2">ğŸ¸ OTHER</span>` : `<span class="bg-blue-100 text-blue-800 text-sm font-bold px-2 py-1 rounded-md mr-2">ğŸ¤ LIVE</span>`;
        modalContent.innerHTML = `\n<div class="flex items-center mb-2">\n${badge}\n<h2 class="text-3xl font-extrabold text-gray-900">${record.liveName}</h2>\n</div>\n<p class="text-xl text-blue-600 mb-4">${record.artist}</p>\n<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">\n<div class="bg-gray-50 p-4 rounded-lg">\n<h3 class="font-semibold text-gray-700 mb-1">ğŸ“… æ—¥ä»˜ / ä¼šå ´</h3>\n<p class="text-lg">${record.date}</p>\n<p class="text-md text-gray-600">${record.venue}</p>\n</div>\n<div class="bg-gray-50 p-4 rounded-lg">\n<h3 class="font-semibold text-gray-700 mb-1">ğŸ« åº§å¸­/æ•´ç†ç•ªå·</h3>\n<p class="text-lg">${record.seatType || 'æƒ…å ±ãªã—'}</p>\n</div>\n</div>\n${record.image ? `<h3 class="font-semibold text-gray-700 mb-2">ğŸ“¸ ãƒ¡ã‚¤ãƒ³ç”»åƒ</h3><img src="${record.image}" alt="ãƒ©ã‚¤ãƒ–ç”»åƒ" class="w-full h-auto rounded-xl shadow-lg mb-6 object-cover max-h-80">` : ''}\n${record.ticketImage ? `<h3 class="font-semibold text-gray-700 mb-2">ğŸ« ãƒã‚±ãƒƒãƒˆç”»åƒ</h3><img src="${record.ticketImage}" alt="ãƒã‚±ãƒƒãƒˆç”»åƒ" class="w-full h-auto rounded-xl shadow-lg mb-6 object-cover max-h-80">` : ''}\n${!isUpcoming && record.setlist && record.setlist.length > 0 ? `<h3 class="font-semibold text-gray-700 mb-2 mt-4 border-b pb-1">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ / ãƒ¡ãƒ¢</h3><ul class="list-none space-y-1">${record.setlist.map((item, idx) => item.type === 'section' ? `<li class="text-blue-600 font-bold mt-2">--- ${item.title} ---</li>` : `<li class="text-gray-700 pl-4">${record.setlist.slice(0, idx+1).filter(it=>it.type==='song').length}. ${item.title}</li>`).join('')}</ul>` : !isUpcoming ? `<p class="text-gray-500 mt-4">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` : ''}`;
    }
};

window.enterEditMode = (id) => {
    const record = liveRecords.find(r => r.id === id);
    if (!record || !isAuthSuccessful) return;
    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç”Ÿæˆ
    renderEditForm(record);
};

function renderEditForm(record) {
    const html = `\n<h2 class="text-2xl font-bold text-gray-800 mb-4">ç·¨é›†: ${record.liveName}</h2>\n<form id="editForm" onsubmit="event.preventDefault(); saveEditedRecord('${record.id}');">\n<div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">\n<label class="block text-sm font-medium text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>\n<div class="flex flex-wrap gap-4">\n<label class="inline-flex items-center cursor-pointer"><input type="radio" name="editType" value="live" ${record.type==='live'?'checked':''} class="form-radio"> <span class="ml-2">ğŸ¤ ãƒ©ã‚¤ãƒ–</span></label>\n<label class="inline-flex items-center cursor-pointer"><input type="radio" name="editType" value="event" ${record.type==='event'?'checked':''} class="form-radio"> <span class="ml-2">ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</span></label>\n<label class="inline-flex items-center cursor-pointer"><input type="radio" name="editType" value="other" ${record.type==='other'?'checked':''} class="form-radio"> <span class="ml-2">ğŸ¸ ãã®ä»–</span></label>\n</div>\n</div>\n<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">\n<div><label class="block text-sm font-medium text-gray-700">æ—¥ä»˜ *</label><input id="editDate" type="date" value="${record.date}" class="w-full p-3 border rounded"></div>\n<div><label class="block text-sm font-medium text-gray-700">ã‚¿ã‚¤ãƒˆãƒ« *</label><input id="editLiveName" value="${record.liveName}" class="w-full p-3 border rounded"></div>\n<div><label class="block text-sm font-medium text-gray-700">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ *</label><input id="editArtist" value="${record.artist}" class="w-full p-3 border rounded"></div>\n<div><label class="block text-sm font-medium text-gray-700">ä¼šå ´ *</label><input id="editVenue" value="${record.venue}" class="w-full p-3 border rounded"></div>\n</div>\n<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">\n<div><label class="block text-sm font-medium text-gray-700">åº§å¸­/æ•´ç†ç•ªå·</label><input id="editSeatType" value="${record.seatType||''}" class="w-full p-3 border rounded"></div>\n<div><label class="block text-sm font-medium text-gray-700">ãƒã‚±ãƒƒãƒˆç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆ)</label><input id="editTicketImageFile" type="file" accept="image/*" class="w-full p-3 border rounded"><p class="text-xs text-gray-500 mt-1">${record.ticketImage? 'â€» ç¾åœ¨ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™':''}</p></div>\n<div><label class="block text-sm font-medium text-gray-700">ç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆ)</label><input id="editImageFile" type="file" accept="image/*" class="w-full p-3 border rounded"><p class="text-xs text-gray-500 mt-1">${record.image? 'â€» ç¾åœ¨ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™':''}</p></div>\n</div>\n<div class="mb-6">${renderSetlistEditor(record.setlist||[], 'edit')}</div>\n<button class="w-full bg-blue-600 text-white py-3 rounded">å¤‰æ›´ã‚’ä¿å­˜</button>\n<button type="button" onclick="cancelEditMode('${record.id}')" class="w-full mt-2 bg-gray-400 text-white py-3 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>\n<p id="editMessage" class="mt-2 text-sm text-green-600"></p>\n</form>`;
    modalContent.innerHTML = html;
    // show modal
    if(detailModal) { detailModal.classList.remove('hidden'); setTimeout(()=>{ detailModal.classList.add('opacity-100'); const box = detailModal.querySelector('.max-w-2xl'); if(box){ box.classList.replace('scale-95','scale-100'); box.classList.replace('opacity-0','opacity-100'); } },10); document.body.style.overflow='hidden'; }
}

window.cancelEditMode = (id) => { openModal(id); };

// --- ç·¨é›†ä¿å­˜ ---
window.saveEditedRecord = async (id) => {
    if (!isAuthSuccessful) return;
    const recordIndex = liveRecords.findIndex(r=>r.id===id);
    if (recordIndex===-1) return;
    const editType = document.querySelector('input[name="editType"]:checked').value;
    const editDate = document.getElementById('editDate').value;
    const editLiveName = document.getElementById('editLiveName').value.trim();
    const editArtist = document.getElementById('editArtist').value.trim();
    const editVenue = document.getElementById('editVenue').value.trim();
    const editSeatType = document.getElementById('editSeatType').value;
    const setlistContainer = document.getElementById('editSetlistEditorContainer');
    const setlistItems = setlistContainer? setlistContainer.querySelectorAll('.setlist-item'): [];
    const editSetlist = Array.from(setlistItems).map(item=>{ const input = item.querySelector('.setlist-song-input'); const title = input? input.value.trim():''; const isSection = input.classList.contains('font-bold'); return isSection? {type:'section', title}: {type:'song', title}; }).filter(i=>i.title && i.title.length>0);
    const editTicketFile = document.getElementById('editTicketImageFile').files[0];
    const editImageFile = document.getElementById('editImageFile').files[0];
    if (!editDate || !editLiveName || !editArtist || !editVenue) { document.getElementById('editMessage').textContent='å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    const editMessage = document.getElementById('editMessage');
    editMessage.textContent = 'ä¿å­˜ä¸­...';
    let ticketUrl = liveRecords[recordIndex].ticketImage || '';
    let imageUrl = liveRecords[recordIndex].image || '';
    if(editTicketFile) ticketUrl = await uploadImageFile(editTicketFile);
    if(editImageFile) imageUrl = await uploadImageFile(editImageFile);
    const updated = { type: editType, date: editDate, liveName: editLiveName, artist: editArtist, venue: editVenue, seatType: editSeatType, setlist: editSetlist, ticketImage: ticketUrl, image: imageUrl };
    await updateRecordInFirestore(id, updated);
    editMessage.textContent = 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
    setTimeout(()=>{ openModal(id); },800);
};

// --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ ---
const closeModal = (event) => { if(event && event.target !== detailModal) return; if(detailModal){ detailModal.classList.remove('opacity-100'); const box = detailModal.querySelector('.max-w-2xl'); if(box){ box.classList.replace('scale-100','scale-95'); box.classList.replace('opacity-100','opacity-0'); } setTimeout(()=>{ detailModal.classList.add('hidden'); document.body.style.overflow=''; },300); } };

const openDeleteConfirmModal = (id) => { recordToDeleteId = id; if(deleteConfirmModal) deleteConfirmModal.classList.remove('hidden'); };
const closeDeleteConfirmModal = () => { recordToDeleteId = null; if(deleteConfirmModal) deleteConfirmModal.classList.add('hidden'); };

// --- openModal ---
const openModal = (id) => {
    const record = liveRecords.find(r=>r.id===id);
    if(!record) return;
    editButtons.innerHTML = '';
    if(isAuthSuccessful){
        const editBtn = document.createElement('button'); editBtn.className='bg-yellow-500 text-white py-2 px-4 rounded mr-2'; editBtn.textContent='ç·¨é›†'; editBtn.onclick=(e)=>{ e.stopPropagation(); enterEditMode(record.id); };
        const deleteBtn = document.createElement('button'); deleteBtn.className='bg-red-500 text-white py-2 px-4 rounded'; deleteBtn.textContent='å‰Šé™¤'; deleteBtn.onclick=(e)=>{ e.stopPropagation(); openDeleteConfirmModal(record.id); };
        editButtons.appendChild(editBtn); editButtons.appendChild(deleteBtn);
    }
    renderDetailContent(record);
    if(detailModal){ detailModal.classList.remove('hidden'); setTimeout(()=>{ detailModal.classList.add('opacity-100'); const box = detailModal.querySelector('.max-w-2xl'); if(box){ box.classList.replace('scale-95','scale-100'); box.classList.replace('opacity-0','opacity-100'); } },10); document.body.style.overflow='hidden'; }
};

// --- å‰Šé™¤å‡¦ç† ---
const deleteRecord = async ()=>{
    if(recordToDeleteId===null) return;
    await deleteRecordFromFirestore(recordToDeleteId);
    closeModal(); closeDeleteConfirmModal();
};

// --- ãƒ•ã‚£ãƒ«ã‚¿é–¢é€£ ---
const populateVenueFilter = ()=>{
    const venues = liveRecords.map(r=>r.venue).filter(Boolean);
    const uniqueVenues = [...new Set(venues)].sort();
    if(filterVenue){ filterVenue.innerHTML = '<option value="">å…¨ã¦ã®ä¼šå ´</option>'; uniqueVenues.forEach(v=>{ const opt = document.createElement('option'); opt.value=v; opt.textContent=v; filterVenue.appendChild(opt); }); }
};

const filterRecords = ()=>{
    if(!searchKeyword||!filterVenue) return;
    const keyword = searchKeyword.value.toLowerCase();
    const selectedVenue = filterVenue.value;
    const now = new Date(); now.setHours(0,0,0,0);
    const filtered = liveRecords.filter(record => {
        const matchesKeyword = (record.liveName && record.liveName.toLowerCase().includes(keyword)) || (record.artist && record.artist.toLowerCase().includes(keyword)) || (record.venue && record.venue.toLowerCase().includes(keyword)) || (record.seatType && record.seatType.toLowerCase().includes(keyword)) || (record.setlist && record.setlist.some(item=>item.title && item.title.toLowerCase().includes(keyword)));
        const matchesVenue = !selectedVenue || record.venue === selectedVenue;
        return matchesKeyword && matchesVenue;
    }).sort((a,b)=> new Date(a.date) - new Date(b.date));

    upcomingList.innerHTML=''; pastList.innerHTML=''; let upcomingCount=0; let pastCount=0;
    filtered.forEach(record=>{
        const liveDate = new Date(record.date);
        const isUpcoming = liveDate >= now;
        const list = isUpcoming ? upcomingList : pastList; if(isUpcoming) upcomingCount++; else pastCount++;
        const card = document.createElement('div'); card.className = `bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer overflow-hidden transform hover:scale-[1.01] ${isUpcoming? 'border-t-4 border-blue-500':'border-t-4 border-gray-400'}`;
        card.onclick = ()=> openModal(record.id);
        const dateParts = record.date.split('-'); const monthDay = `${dateParts[1]}/${dateParts[2]}`; const year = dateParts[0];
        let badge = record.type==='event'? `<span class="bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded border border-orange-200">ğŸª EVENT</span>` : record.type==='other'? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded border border-green-200">ğŸ¸ OTHER</span>` : `<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded border border-blue-200">ğŸ¤ LIVE</span>`;
        card.innerHTML = `\n<div class="relative h-40">\n<img src="${record.image||record.ticketImage|| `https://placehold.co/600x400/e5e7eb/737373?text=${encodeURIComponent(record.artist||'LIVE')}`}" alt="ç”»åƒ" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x400/e5e7eb/737373?text=${encodeURIComponent(record.artist||'LIVE')}'">\n<div class="absolute inset-0 bg-gradient-to-t from-gray-900/70 to-transparent"></div>\n<div class="absolute top-0 right-0 m-2 flex space-x-2">${badge}</div>\n</div>\n<div class="p-4">\n<p class="text-xs text-gray-500">${year}</p>\n<p class="text-2xl font-extrabold text-gray-800 mb-1">${monthDay}</p>\n<h3 class="text-xl font-bold text-gray-900 truncate">${record.liveName}</h3>\n<p class="text-sm text-gray-600 truncate">${record.artist} @ ${record.venue}</p>\n</div>`;
        list.appendChild(card);
    });

    const hasResults = upcomingCount>0 || pastCount>0;
    const noResultsElem = document.getElementById('noResults'); if(noResultsElem) noResultsElem.classList.toggle('hidden', hasResults);
    upcomingList.classList.toggle('hidden', upcomingCount === 0 && !noResultsElem.classList.contains('hidden'));
    pastList.classList.toggle('hidden', pastCount === 0 && !noResultsElem.classList.contains('hidden'));
    document.getElementById('upcomingTitle').classList.toggle('hidden', upcomingCount===0);
    document.getElementById('pastTitle').classList.toggle('hidden', pastCount===0);
};

// --- èªè¨¼ ---
if(authenticateBtn) { authenticateBtn.addEventListener('click', async ()=>{
    if(checkLockout()) return;
    const password = passwordInput.value; if(!password){ authMessage.textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; authMessage.className='mt-2 text-sm text-red-500'; return; }
    try{ const inputHash = await sha256(password); if(inputHash === CORRECT_PASSWORD_HASH){ isAuthSuccessful = true; authMessage.textContent='èªè¨¼æˆåŠŸï¼äºˆå®šã®è¿½åŠ ãƒ»ç·¨é›†ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚'; authMessage.className='mt-2 text-sm text-green-600 font-bold'; authArea.classList.add('hidden'); addRecordForm.classList.remove('hidden'); localStorage.removeItem('authAttempts'); localStorage.removeItem('lockoutEnd'); filterRecords(); if(addSetlistArea) addSetlistArea.innerHTML = renderSetlistEditor([], 'add'); } else { let attempts = parseInt(localStorage.getItem('authAttempts')||'0'); attempts++; localStorage.setItem('authAttempts', attempts); if(attempts>=MAX_ATTEMPTS){ localStorage.setItem('lockoutEnd', Date.now()+LOCKOUT_DURATION_MS); checkLockout(); } else { authMessage.textContent = `èªè¨¼å¤±æ•—ã€‚æ®‹ã‚Š ${MAX_ATTEMPTS - attempts} å›ã§ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚`; authMessage.className='mt-2 text-sm text-red-500'; } passwordInput.value=''; } } catch(e){ console.error(e); authMessage.textContent='èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; authMessage.className='mt-2 text-sm text-red-500'; }
}); }

// --- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç† ---
if(addRecordForm) addRecordForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); if(!isAuthSuccessful) return;
    const newType = document.querySelector('input[name="newType"]:checked').value;
    const newDate = document.getElementById('newDate').value; const newLiveName = document.getElementById('newLiveName').value.trim(); const newArtist = document.getElementById('newArtist').value.trim(); const newVenue = document.getElementById('newVenue').value.trim(); const newSeatType = document.getElementById('newSeatType').value;
    const setlistContainer = document.getElementById('addSetlistEditorContainer'); const setlistItems = setlistContainer? setlistContainer.querySelectorAll('.setlist-item'): []; const newSetlist = Array.from(setlistItems).map(item=>{ const input = item.querySelector('.setlist-song-input'); const title = input? input.value.trim():''; const isSection = input.classList.contains('font-bold'); return isSection? {type:'section', title}: {type:'song', title}; }).filter(i=>i.title && i.title.length>0);
    const newTicketFile = document.getElementById('newTicketImageFile').files[0]; const newImageFile = document.getElementById('newImageFile').files[0];
    if(!newDate||!newLiveName||!newArtist||!newVenue){ addMessage.textContent='æ—¥ä»˜ã€ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã€ä¼šå ´åã¯å¿…é ˆã§ã™ã€‚'; addMessage.className='mt-2 text-sm text-red-600 font-bold'; return; }
    addMessage.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
    const ticketUrl = await uploadImageFile(newTicketFile); const imageUrl = await uploadImageFile(newImageFile);
    const newRecord = { type: newType, date: newDate, liveName: newLiveName, artist: newArtist, venue: newVenue, image: imageUrl, ticketImage: ticketUrl, seatType: newSeatType, setlist: newSetlist };
    await addRecordToFirestore(newRecord);
    addRecordForm.reset(); if(addSetlistArea) addSetlistArea.innerHTML = renderSetlistEditor([], 'add'); addMessage.textContent = `ã€Œ${newLiveName}ã€ã®äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`;
});

if(confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', deleteRecord);
if(searchKeyword) searchKeyword.addEventListener('input', filterRecords);
if(filterVenue) filterVenue.addEventListener('change', filterRecords);
if(toggleAddFormBtn) toggleAddFormBtn.addEventListener('click', ()=>{ if(addRecordSection) addRecordSection.classList.toggle('hidden'); if(isAuthSuccessful && addRecordForm){ addRecordForm.reset(); if(addSetlistArea) addSetlistArea.innerHTML = renderSetlistEditor([], 'add'); } });
if(toggleFilterBtn) toggleFilterBtn.addEventListener('click', ()=>{ if(filterArea) filterArea.classList.toggle('hidden'); });

// --- åˆæœŸåŒ– ---
window.onload = async ()=>{
    if(window.innerWidth < 768 && filterArea) filterArea.classList.add('hidden');
    await seedIfEmpty();
    startRealtimeListener();
    checkLockout();
};
</script>

<!-- ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶å‰Šé™¤ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰ -->
<script>
if ('caches' in window) {
    caches.keys().then(function(names) {
    for (let name of names) caches.delete(name);
    });
}

// service worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for (let registration of registrations) {
        registration.unregister();
    }
    });
}
</script>
</body>
</html>









