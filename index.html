<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ–è¨˜éŒ²</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆç›®ç«‹ãŸãªã„ã‚ˆã†ã«ï¼‰ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f8fafc; /* slate-50 */
        }
        /* ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Blue-gray-100 */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-gray-800 text-white shadow-lg sticky top-0 z-10">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold tracking-tight">ğŸ¶ My Live Records</h1>
            <div class="flex space-x-3">
                <button id="toggleAddForm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-colors text-sm">
                    ãƒ©ã‚¤ãƒ–ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã¯ã“ã¡ã‚‰
                </button>
                <button id="toggleFilter" class="p-2 rounded-lg hover:bg-gray-700 transition-colors md:hidden text-sm">
                    çµã‚Šè¾¼ã¿
                </button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <main class="max-w-4xl mx-auto p-4">

        <!-- ãƒ©ã‚¤ãƒ–è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  (èªè¨¼å¾Œè¡¨ç¤º) -->
        <div id="addRecordSection" class="bg-white p-4 rounded-xl shadow-2xl mb-6 hidden border-l-4 border-blue-500">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ãƒ©ã‚¤ãƒ–è¨˜éŒ²è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤</h2>

            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚¨ãƒªã‚¢ -->
            <div id="authArea">
                <p class="text-sm text-gray-500 mb-3 font-medium">â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã‚ˆã‚Šã€ãƒ©ã‚¤ãƒ–äºˆå®šã®è¿½åŠ ãƒ»ç·¨é›†ãŒå¯èƒ½ã§ã™ã€‚</p>
                <div class="flex space-x-2">
                    <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="authenticateBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-5 rounded-lg transition-colors">èªè¨¼</button>
                </div>
                <p id="authMessage" class="mt-2 text-sm text-red-500"></p>
            </div>

            <!-- ãƒ©ã‚¤ãƒ–è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  (èªè¨¼æˆåŠŸå¾Œ) -->
            <form id="addRecordForm" class="hidden mt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="newDate" class="block text-sm font-medium text-gray-700">æ—¥ä»˜ *</label>
                        <input type="date" id="newDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="newLiveName" class="block text-sm font-medium text-gray-700">ãƒ©ã‚¤ãƒ–å *</label>
                        <input type="text" id="newLiveName" placeholder="ä¾‹: Channel U Tour 2025" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="newArtist" class="block text-sm font-medium text-gray-700">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå *</label>
                        <input type="text" id="newArtist" placeholder="ä¾‹: ç·‘é»„è‰²ç¤¾ä¼š" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="newVenue" class="block text-sm font-medium text-gray-700">ä¼šå ´å *</label>
                        <input type="text" id="newVenue" placeholder="ä¾‹: æ°´æˆ¸å¸‚æ°‘ä¼šé¤¨" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="newSeatType" class="block text-sm font-medium text-gray-700">å¸­ç¨® (ä»»æ„)</label>
                        <input type="text" id="newSeatType" placeholder="ä¾‹: 1éš 15åˆ— 11ç•ª" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="newTicketImageFile" class="block text-sm font-medium text-gray-700">ãƒã‚±ãƒƒãƒˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (ä»»æ„)</label>
                        <input type="file" id="newTicketImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="newImageFile" class="block text-sm font-medium text-gray-700">ãƒ©ã‚¤ãƒ–ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (ä»»æ„)</label>
                        <input type="file" id="newImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ (æ–°è¦è¿½åŠ ç”¨) -->
                <div class="mb-6" id="addSetlistArea">
                    <!-- JSã§ã“ã“ã«ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                    ãƒ©ã‚¤ãƒ–äºˆå®šã‚’ç™»éŒ²
                </button>
                <p id="addMessage" class="mt-2 text-sm text-green-600"></p>
            </form>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/æ¤œç´¢ã‚¨ãƒªã‚¢ (ãƒ¢ãƒã‚¤ãƒ«ã§ã¯éè¡¨ç¤º/ãƒˆã‚°ãƒ«) -->
        <div id="filterArea" class="bg-white p-4 rounded-xl shadow-md mb-6 md:block">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã‚’æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="text" id="searchKeyword" placeholder="ãƒ©ã‚¤ãƒ–åã€ãƒãƒ³ãƒ‰åã€ä¼šå ´ã€å¸­ç¨®ã€æ¥½æ›²åã§æ¤œç´¢" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <select id="filterVenue" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">å…¨ã¦ã®ä¼šå ´</option>
                    <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JSã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </select>
            </div>
        </div>

        <!-- è¨˜éŒ²ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ - ä»Šå¾Œã®äºˆå®š -->
        <h2 id="upcomingTitle" class="text-2xl font-bold text-gray-700 mb-4 mt-6 border-b-2 border-blue-500 pb-1">ğŸ“… Upcoming Lives (ä»Šå¾Œã®äºˆå®š)</h2>
        <section id="upcomingList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></section>

        <!-- è¨˜éŒ²ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ - çµ‚äº†æ¸ˆã¿ -->
        <h2 id="pastTitle" class="text-2xl font-bold text-gray-700 mb-4 mt-10 border-b-2 border-gray-400 pb-1">ğŸ¤ Past Lives (çµ‚äº†æ¸ˆã¿)</h2>
        <section id="pastList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></section>

        <!-- çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="noResults" class="hidden text-center p-12 bg-white rounded-xl shadow-md mt-6">
            <p class="text-xl text-gray-500 font-medium">ãŠæ¢ã—ã®ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            <p class="text-gray-400 mt-2">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
        </div>
    </main>

    <!-- ãƒ©ã‚¤ãƒ–è©³ç´°/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤) -->
    <div id="detailModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300" onclick="closeModal(event)">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl overflow-y-auto transform scale-95 opacity-0 transition-all duration-300" role="dialog" aria-modal="true" aria-labelledby="modalTitle" onclick="event.stopPropagation()">
            <div class="p-6">
                <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¨ç·¨é›†ãƒœã‚¿ãƒ³ -->
                <div class="flex justify-between items-center mb-4">
                    <div id="editButtons" class="space-x-2">
                        <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ (JSã§è¿½åŠ ) -->
                    </div>
                    <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (è©³ç´°è¡¨ç¤º or ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ) -->
                <div id="modalContent">
                    <!-- è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„/ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãŒJSã«ã‚ˆã£ã¦ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-red-600 mb-4">ğŸš¨ è¨˜éŒ²ã®å‰Šé™¤ç¢ºèª</h3>
            <p class="mb-6 text-gray-700">æœ¬å½“ã«ã“ã®ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸€åº¦å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨èªè¨¼ç”¨ã®å®šæ•° ---
        // SHA-256ãƒãƒƒã‚·ãƒ¥å€¤: 'maru0118' -> eb28853c3f343b83dbca201d27050f6d873b3da473aad7eeecd8f50722461861
        const CORRECT_PASSWORD_HASH = 'eb28853c3f343b83dbca201d27050f6d873b3da473aad7eeecd8f50722461861';
        const MAX_ATTEMPTS = 20;
        const LOCKOUT_DURATION_MS = 30 * 60 * 1000; // 30åˆ†é–“ã®ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

        let isAuthSuccessful = false; 

        // --- SHA-256ãƒãƒƒã‚·ãƒ¥é–¢æ•° ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);                    
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // --- ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®ç¢ºèª ---
        function checkLockout() {
            const lockoutEnd = localStorage.getItem('lockoutEnd');
            const attempts = parseInt(localStorage.getItem('authAttempts') || '0');
            const now = Date.now();

            if (lockoutEnd && parseInt(lockoutEnd) > now) {
                const remaining = Math.ceil((parseInt(lockoutEnd) - now) / 60000);
                authMessage.textContent = `èªè¨¼ã«å¤±æ•—ã—ã™ããŸãŸã‚ã€æ®‹ã‚Š ${remaining} åˆ†é–“ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
                authMessage.className = "mt-2 text-sm text-red-600 font-bold";
                authenticateBtn.disabled = true;
                passwordInput.disabled = true;
                return true;
            } else if (attempts >= MAX_ATTEMPTS) {
                localStorage.removeItem('authAttempts');
                localStorage.removeItem('lockoutEnd');
            }
            authenticateBtn.disabled = false;
            passwordInput.disabled = false;
            return false;
        }

        // --- ãƒ©ã‚¤ãƒ–è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã¨åŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯ ---

        // ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ (ID: 1-23)
        const initialRecords = [
            { id: 1, date: "2022-05-01", liveName: "Actor Tour 2022", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "ç¦å²¡ã‚µãƒ³ãƒ‘ãƒ¬ã‚¹", image: "", ticketImage: "", seatType: "1éš 10åˆ— 1ç•ª", setlist: ["Actor", "LITMUS", "Mela!", "Shout Baby", "S.T.A.R."] },
            { id: 2, date: "2022-11-27", liveName: "LIVE TOUR 2022 Labo.", artist: "Snow man", venue: "ãƒãƒªãƒ³ãƒ¡ãƒƒã‚»ç¦å²¡", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ Aãƒ–ãƒ­ãƒƒã‚¯ 10ç•ª", setlist: ["D.D.", "ãƒ–ãƒ©ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒˆ", "ã‚ªãƒ¬ãƒ³ã‚¸kiss", "JUICY", "Secret Touch"] },
            { id: 3, date: "2023-06-10", liveName: "pink blue tour 2023", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "ç¦å²¡ã‚µãƒ³ãƒ‘ãƒ¬ã‚¹", image: "", ticketImage: "", seatType: "2éš 1åˆ— 20ç•ª", setlist: ["ã‚µãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©", "å§‹ã¾ã‚Šã®æ­Œ", "Sabotage", "ä¸€æ­©", "èŠ±ã«ãªã£ã¦"] },
            { id: 4, date: "2024-03-09", liveName: "LIVE TOUR VVS", artist: "SixTONES", venue: "ç¦å²¡paypayãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ã‚¹ã‚¿ãƒ³ãƒ‰ 5å¡å´ 10é€šè·¯", setlist: ["ã“ã£ã‹ã‚‰", "NAVIGATOR", "Imitation Rain", "NEW ERA", "Good Luck!"] },
            { id: 5, date: "2024-03-30", liveName: "Arena Tour 2024 Gates+", artist: "ç¾å°‘å¹´", venue: "æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "ã‚»ãƒ³ã‚¿ãƒ¼å¸­ 10ãƒ–ãƒ­ãƒƒã‚¯ 1ç•ª", setlist: ["æœªæ¥ãŒå§‹ã¾ã‚‹", "Cosmic Melody", "Beautiful Love", "LALA LOVE", "è™¹ã®ä¸­ã§"] },
            { id: 6, date: "2024-06-16", liveName: "ç·‘é»„è‰²ç¤¾ä¼šå¤§å¤œç¥­", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "æ¨ªæµœã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠå¸­ 5åˆ— 5ç•ª", setlist: ["æ‹ã‚’ã—ã‚ˆã†", "Re", "Party!!", "ã«ã¡ã‚ˆã†ã³", "ã‚ã®é ƒã®æ­Œ"] },
            { id: 7, date: "2024-11-10", liveName: "YOASOBI DOME LIVE 2024", artist: "YOASOBI", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ãƒãƒ«ã‚³ãƒ‹ãƒ¼å¸­ 1åˆ— 1ç•ª", setlist: ["ã‚¢ã‚¤ãƒ‰ãƒ«", "å¤œã«é§†ã‘ã‚‹", "ç¾¤é’", "ç¥ç¦", "å‹‡è€…"] },
            { id: 8, date: "2024-11-23", liveName: "LIVE HOUSE TOUR Laugh", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "Zepp Haneda", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 9, date: "2024-12-15", liveName: "Snow Man Dome Tour 2024 RAVS", artist: "Snow Man", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ", setlist: [] },
            { id: 10, date: "2025-04-04", liveName: "CENTRAL STAGE", artist: "ç·‘é»„è‰²ç¤¾ä¼š/ä¹ƒæœ¨å‚46", venue: "Kã‚¢ãƒªãƒ¼ãƒŠæ¨ªæµœ", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ", setlist: [] },
            { id: 11, date: "2025-04-06", liveName: "Echoes Baa", artist: "YOASOBI/FRUITS ZIPPER etc", venue: "æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 12, date: "2025-05-02", liveName: "Channel U Tour 2025", artist: "FRUITS ZIPPER", venue: "æ°´æˆ¸å¸‚æ°‘ä¼šé¤¨", image: "", ticketImage: "", seatType: "1éš 15åˆ— 11ç•ª", setlist: [] },
            { id: 13, date: "2025-07-05", liveName: "Channel Me", artist: "ç·‘é»„è‰²ç¤¾ä¼š", venue: "æ±äº¬ä½“è‚²é¤¨", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 14, date: "2025-07-20", liveName: "ASOBI EXPO", artist: "ãã‚ƒã‚Šãƒ¼ã±ã¿ã‚…ã±ã¿ã‚…/æ–°ã—ã„å­¦æ ¡ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚º/FRUITS ZIPPER/CUTIE STREET/Kizuna AI/Touka/Rung Ruler", venue: "å¹•å¼µãƒ¡ãƒƒã‚»å›½éš›å±•ç¤ºå ´ 9ãƒ»10ãƒ»11ãƒ›ãƒ¼ãƒ«", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 15, date: "2025-08-02", liveName: "FRUITS ZIPPER 3rd ANNIVERSARY", artist: "FRUITS ZIPPER", venue: "ã•ã„ãŸã¾ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒªãƒ¼ãƒŠ", image: "", ticketImage: "", seatType: "200ãƒ¬ãƒ™ãƒ« 2åˆ— 333ç•ª", setlist: [] },
            { id: 16, date: "2025-08-30", liveName: "è¶…ã¨ãã‚ãâ™¡å®£ä¼éƒ¨ã®ãã¿ã®ãƒãƒ¼ãƒˆã«ãƒ­ãƒƒã‚¯ã‚ªãƒ³TOUR 2025 10th Anniversary", artist: "è¶…ã¨ãã‚ãâ™¡å®£ä¼éƒ¨", venue: "ãƒ‘ã‚·ãƒ•ã‚£ã‚³æ¨ªæµœå›½ç«‹å¤§ãƒ›ãƒ¼ãƒ«", image: "", ticketImage: "", seatType: "2éšé€šè·¯ç·šå´", setlist: [] },
            { id: 17, date: "2025-09-19", liveName: "éŸ³æ¥½ã®æ—¥ãƒ•ã‚§ã‚¹", artist: "FRUITS ZIPPER/CANDY TUNE/SWEET STEADY", venue: "æ±äº¬ã‚¬ãƒ¼ãƒ‡ãƒ³ã‚·ã‚¢ã‚¿ãƒ¼", image: "", ticketImage: "", seatType: "ã‚¢ãƒªãƒ¼ãƒŠ 3åˆ— 10ç•ª", setlist: [] },
            { id: 18, date: "2025-10-04", liveName: "ã¯ã¡ã‚ƒã‚ã¡ã‚ƒã‚ã¡ã‚ƒã‚ã¡ã‚ƒãƒ©ã‚¤ãƒ–", artist: "FRUITS ZIPPER", venue: "è±Šæ´²PIT 8ãƒ›ãƒ¼ãƒ«", image: "", ticketImage: "", seatType: "C1ãƒ–ãƒ­ãƒƒã‚¯åˆ—2ç•ªï¼ˆç«¯ï¼‰", setlist: [] },
            { id: 19, date: "2025-10-07", liveName: "COSMIC CIRCUS", artist: "ç·‘é»„è‰²ç¤¾ä¼š/Aqua Timez", venue: "Zeppç¾½ç”°", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 20, date: "2025-10-13", liveName: "CUTIE STREET 1st ANNIVERSARY JAPAN TOUR 2025ã€ŒCAN'T STOP CUTIE.ã€", artist: "CUTIE STREET", venue: "ã´ã‚ã‚¢ãƒªãƒ¼ãƒŠMM", image: "", ticketImage: "https://placehold.co/100x100/e5e7eb/737373?text=Ticket", seatType: "ã‚¢ãƒªãƒ¼ãƒŠCãƒ–ãƒ­ãƒƒã‚¯ 4åˆ— 6ç•ª", setlist: [] },
            { id: 21, date: "2025-11-17", liveName: "SWEET STEADY JAPAN TOUR 2025 - AUTUMN -Collection", artist: "SWEET STEADY", venue: "Zepp DiverCity", image: "", ticketImage: "https://placehold.co/100x100/e5e7eb/737373?text=Ticket", seatType: "", setlist: [] },
            { id: 22, date: "2025-12-13", liveName: "KAWAII.LAB SESSION", artist: "FRUITS ZIPPER/CANDY TUNE/SWEET STEADY/CUTIE STREET", venue: "Kã‚¢ãƒªãƒ¼ãƒŠæ¨ªæµœ", image: "", ticketImage: "", seatType: "", setlist: [] },
            { id: 23, date: "2026-02-04", liveName: "FRUITS ZIPPER SPECIAL LIVE 2026", artist: "FRUITS ZIPPER", venue: "æ±äº¬ãƒ‰ãƒ¼ãƒ ", image: "", ticketImage: "", seatType: "", setlist: [] },
        ];

        // localStorageã‹ã‚‰ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰
        const loadRecords = () => {
            let records = JSON.parse(localStorage.getItem('userLiveRecords') || 'null');

            if (records === null || records.length === 0) {
                records = initialRecords.map(record => ({...record}));
            }

            // äº’æ›æ€§ã®ãŸã‚ã€æ—¢å­˜ã®stringé…åˆ—ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›ã™ã‚‹
            records.forEach(r => {
                if (!Array.isArray(r.setlist)) r.setlist = [];
                r.setlist = r.setlist.map(item => {
                    if (typeof item === 'string') return { type: 'song', title: item };
                    // æ—¢ã«æ–°å½¢å¼ãªã‚‰ãã®ã¾ã¾
                    return item;
                });
            });

            localStorage.setItem('userLiveRecords', JSON.stringify(records));
            return records;
        };

        let liveRecords = loadRecords();

        // ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
        const saveRecords = () => {
            localStorage.setItem('userLiveRecords', JSON.stringify(liveRecords));
        };

        // HTMLè¦ç´ ã®å‚ç…§
        const upcomingList = document.getElementById('upcomingList');
        const pastList = document.getElementById('pastList');
        const searchKeyword = document.getElementById('searchKeyword');
        const filterVenue = document.getElementById('filterVenue');
        const detailModal = document.getElementById('detailModal');
        const modalContent = document.getElementById('modalContent');
        const editButtons = document.getElementById('editButtons');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const toggleAddFormBtn = document.getElementById('toggleAddForm');
        const addRecordSection = document.getElementById('addRecordSection');
        const addRecordForm = document.getElementById('addRecordForm');
        const addMessage = document.getElementById('addMessage');
        const addSetlistArea = document.getElementById('addSetlistArea');
        const authArea = document.getElementById('authArea');
        const passwordInput = document.getElementById('passwordInput');
        const authenticateBtn = document.getElementById('authenticateBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleFilterBtn = document.getElementById('toggleFilter');
        const filterArea = document.getElementById('filterArea');

        let recordToDeleteId = null;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const closeModal = (event) => {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã®ã¿é–‰ã˜ã‚‹
            if (event && event.target !== detailModal) return;

            detailModal.classList.remove('opacity-100');
            detailModal.querySelector('.max-w-2xl').classList.replace('scale-100', 'scale-95');
            detailModal.querySelector('.max-w-2xl').classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => {
                detailModal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        };

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const openDeleteConfirmModal = (id) => {
            recordToDeleteId = id;
            deleteConfirmModal.classList.remove('hidden');
        };

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const closeDeleteConfirmModal = () => {
            recordToDeleteId = null;
            deleteConfirmModal.classList.add('hidden');
        };

        // --- ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆç·¨é›†ç”¨UIã®å‹•çš„ç”Ÿæˆ (æ›²+ã‚»ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ) ---
        // mode: 'add' (æ–°è¦è¿½åŠ ç”¨) ã¾ãŸã¯ 'edit' (ç·¨é›†ç”¨)
        const renderSetlistEditor = (setlist, mode) => {
            const containerId = `${mode}SetlistEditorContainer`;
            const inputId = `${mode}NewSongInput`;

            // setlistã¯é…åˆ—ã®è¦ç´ ãŒ {type:'song'|'section', title: '...'} ã®å½¢å¼
            const itemsHtml = setlist.map((item, index) => {
                if (item.type === 'section') {
                    return `
                        <div class="flex items-center space-x-2 mb-2 setlist-item">
                            <span class="text-gray-400 font-bold w-6 text-right">-</span>
                            <input type="text" value="${item.title}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input font-bold text-blue-600">
                            <button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex items-center space-x-2 mb-2 setlist-item">
                            <span class="text-gray-400 font-bold w-6 text-right">${index + 1}.</span>
                            <input type="text" value="${item.title}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input">
                            <button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</label>
                    <div id="${containerId}">
                        ${itemsHtml}
                    </div>
                    <div class="flex mt-3 space-x-2">
                        <input type="text" id="${inputId}" placeholder="æ›²åã‚’å…¥åŠ›" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500" onkeydown="if(event.key==='Enter'){event.preventDefault(); addSetlistItem('${mode}');}">
                        <button type="button" onclick="addSetlistItem('${mode}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors">
                            æ›²è¿½åŠ 
                        </button>
                    </div>

                    <div class="flex mt-3 space-x-2">
                        <button type="button" onclick="addSection('${mode}', 'è¡£è£…æ›¿ãˆ')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">è¡£è£…æ›¿ãˆè¿½åŠ </button>
                        <button type="button" onclick="addSection('${mode}', 'ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«è¿½åŠ </button>
                        <button type="button" onclick="addSection('${mode}', 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded">ãƒ¡ãƒ‰ãƒ¬ãƒ¼è¿½åŠ </button>
                    </div>
                </div>
            `;
        };

        // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã«é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•° (Global Scope)
        // mode: 'add' or 'edit'
        window.addSetlistItem = (mode) => {
            const containerId = `${mode}SetlistEditorContainer`;
            const inputId = `${mode}NewSongInput`;

            const input = document.getElementById(inputId);
            const songName = input.value.trim();
            if (!songName) return;

            const container = document.getElementById(containerId);

            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 mb-2 setlist-item';
            div.innerHTML = `
                <span class="text-gray-400 font-bold w-6 text-right">-</span>
                <input type="text" value="${songName}" class="flex-grow p-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 setlist-song-input">
                <button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            `;

            // ensure the input is recognized as a song (remove font-bold if any)
            const newInput = div.querySelector('.setlist-song-input');
            newInput.classList.remove('font-bold');
            newInput.classList.remove('text-blue-600');

            container.appendChild(div);
            input.value = '';
            input.focus();

            // ç•ªå·ã®æŒ¯ã‚Šç›´ã—ï¼ˆæ­Œã®ã¿ã‚’æ•°ãˆã‚‹ï¼‰
            renumberSetlist(containerId);
        };

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡£è£…æ›¿ãˆ/ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«ç­‰ï¼‰ã‚’è¿½åŠ ã™ã‚‹
        window.addSection = (mode, title) => {
            const containerId = `${mode}SetlistEditorContainer`;
            const container = document.getElementById(containerId);

            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 mb-2 setlist-item';

            div.innerHTML = `
                <span class="text-gray-400 font-bold w-6 text-right">-</span>
                <input type="text" value="${title}" class="flex-grow p-2 border border-gray-300 rounded setlist-song-input font-bold text-blue-600">
                <button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-500 hover:text-red-700 p-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            `;

            container.appendChild(div);
            renumberSetlist(containerId);
        };

        // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‹ã‚‰é …ç›®ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•° (Global Scope)
        window.removeSetlistItem = (btn, containerId) => {
            const item = btn.closest('.setlist-item');
            item.remove();
            renumberSetlist(containerId);
        };

        // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™é–¢æ•°ï¼ˆæ­Œã ã‘ã‚’é€£ç•ªã«ã™ã‚‹ã€‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ '-' è¡¨ç¤ºï¼‰
        const renumberSetlist = (containerId) => {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.setlist-item');
            let songIndex = 0;
            items.forEach((item) => {
                const numSpan = item.querySelector('span');
                const input = item.querySelector('.setlist-song-input');
                if (!numSpan || !input) return;

                const isSection = input.classList.contains('font-bold');
                if (isSection) {
                    numSpan.textContent = '-';
                } else {
                    songIndex++;
                    numSpan.textContent = `${songIndex}.`;
                }
            });
        };

        // è©³ç´°è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        const renderDetailContent = (record, isEditMode = false) => {
            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                modalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ©ã‚¤ãƒ–è¨˜éŒ²ã®ç·¨é›†</h2>
                    <form id="editForm" onsubmit="event.preventDefault(); saveEditedRecord(${record.id});">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="editDate" class="block text-sm font-medium text-gray-700">æ—¥ä»˜ *</label>
                                <input type="date" id="editDate" value="${record.date}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="editLiveName" class="block text-sm font-medium text-gray-700">ãƒ©ã‚¤ãƒ–å *</label>
                                <input type="text" id="editLiveName" value="${record.liveName}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="editArtist" class="block text-sm font-medium text-gray-700">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå *</label>
                                <input type="text" id="editArtist" value="${record.artist}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="editVenue" class="block text-sm font-medium text-gray-700">ä¼šå ´å *</label>
                                <input type="text" id="editVenue" value="${record.venue}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="editSeatType" class="block text-sm font-medium text-gray-700">å¸­ç¨® (ä»»æ„)</label>
                                <input type="text" id="editSeatType" value="${record.seatType || ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="editTicketImageFile" class="block text-sm font-medium text-gray-700">ãƒã‚±ãƒƒãƒˆç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆ)</label>
                                <input type="file" id="editTicketImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                ${record.ticketImage ? '<p class="text-xs text-gray-500 mt-1">â€» ç¾åœ¨ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™</p>' : ''}
                            </div>
                            <div>
                                <label for="editImageFile" class="block text-sm font-medium text-gray-700">ãƒ©ã‚¤ãƒ–ç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆ)</label>
                                <input type="file" id="editImageFile" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                ${record.image ? '<p class="text-xs text-gray-500 mt-1">â€» ç¾åœ¨ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™</p>' : ''}
                            </div>
                        </div>

                        <!-- ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ (editãƒ¢ãƒ¼ãƒ‰) -->
                        <div class="mb-6">
                            ${renderSetlistEditor(record.setlist || [], 'edit')}
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                            å¤‰æ›´ã‚’ä¿å­˜
                        </button>
                        <button type="button" onclick="cancelEditMode(${record.id})" class="w-full mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <p id="editMessage" class="mt-2 text-sm text-green-600"></p>
                    </form>
                `;
                // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
                editButtons.innerHTML = ''; 
            } else {
                // è©³ç´°è¡¨ç¤ºã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const isUpcoming = new Date(record.date) >= new Date(new Date().setHours(0, 0, 0, 0));

                modalContent.innerHTML = `
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-2">${record.liveName}</h2>
                    <p class="text-xl text-blue-600 mb-4">${record.artist}</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-gray-700 mb-1">ğŸ“… æ—¥ä»˜ / ä¼šå ´</h3>
                            <p class="text-lg">${record.date}</p>
                            <p class="text-md text-gray-600">${record.venue}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-gray-700 mb-1">ğŸ« å¸­ç¨®</h3>
                            <p class="text-lg">${record.seatType || 'æƒ…å ±ãªã—'}</p>
                        </div>
                    </div>

                    ${record.image ? `
                        <h3 class="font-semibold text-gray-700 mb-2">ğŸ“¸ ãƒ©ã‚¤ãƒ–ç”»åƒ</h3>
                        <img src="${record.image}" alt="ãƒ©ã‚¤ãƒ–ç”»åƒ" class="w-full h-auto rounded-xl shadow-lg mb-6 object-cover max-h-80">
                    ` : ''}

                    ${record.ticketImage ? `
                        <h3 class="font-semibold text-gray-700 mb-2">ğŸ« ãƒã‚±ãƒƒãƒˆç”»åƒ</h3>
                        <img src="${record.ticketImage}" alt="ãƒã‚±ãƒƒãƒˆç”»åƒ" class="w-full h-auto rounded-xl shadow-lg mb-6 object-cover max-h-80">
                    ` : ''}

                    ${!isUpcoming && record.setlist && record.setlist.length > 0 ? `
                        <h3 class="font-semibold text-gray-700 mb-2 mt-4 border-b pb-1">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3>
                        <ul class="list-none space-y-1">
                            ${record.setlist.map((item, idx) => {
                                if (item.type === 'section') {
                                    return `<li class="text-blue-600 font-bold mt-2">--- ${item.title} ---</li>`;
                                } else {
                                    // count song index up to this point
                                    const songNum = record.setlist.slice(0, idx+1).filter(it => it.type === 'song').length;
                                    return `<li class="text-gray-700 pl-4 relative before:content-['#'] before:absolute before:left-0 before:font-bold before:text-blue-400">${songNum}. ${item.title}</li>`;
                                }
                            }).join('')}
                        </ul>
                    ` : !isUpcoming ? `
                        <p class="text-gray-500 mt-4">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    ` : ''}

                `;
            }
        };

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
        const enterEditMode = (id) => {
            const record = liveRecords.find(r => r.id === id);
            if (!record || !isAuthSuccessful) return;
            renderDetailContent(record, true);
        };

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        const cancelEditMode = (id) => {
            const record = liveRecords.find(r => r.id === id);
            if (!record) return;
            // è©³ç´°è¡¨ç¤ºã«æˆ»ã‚‹
            openModal(id); 
        };

        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve('');
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // ç·¨é›†å†…å®¹ã‚’ä¿å­˜
        const saveEditedRecord = async (id) => {
            const recordIndex = liveRecords.findIndex(r => r.id === id);
            if (recordIndex === -1 || !isAuthSuccessful) return;

            const editDate = document.getElementById('editDate').value;
            const editLiveName = document.getElementById('editLiveName').value;
            const editArtist = document.getElementById('editArtist').value;
            const editVenue = document.getElementById('editVenue').value;
            const editSeatType = document.getElementById('editSeatType').value;

            // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ (ç·¨é›†ç”¨ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰)
            const setlistContainer = document.getElementById('editSetlistEditorContainer');
            const setlistItems = setlistContainer.querySelectorAll('.setlist-item');
            const editSetlist = Array.from(setlistItems).map(item => {
                const input = item.querySelector('.setlist-song-input');
                const title = input.value.trim();
                const isSection = input.classList.contains('font-bold');
                return isSection ? { type: 'section', title } : { type: 'song', title };
            }).filter(i => i.title && i.title.length > 0);

            const editTicketImageFile = document.getElementById('editTicketImageFile').files[0];
            const editImageFile = document.getElementById('editImageFile').files[0];
            const editMessage = document.getElementById('editMessage');

            if (!editDate || !editLiveName || !editArtist || !editVenue) {
                editMessage.textContent = 'æ—¥ä»˜ã€ãƒ©ã‚¤ãƒ–åã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã€ä¼šå ´åã¯å¿…é ˆã§ã™ã€‚';
                editMessage.className = "mt-2 text-sm text-red-600 font-bold";
                return;
            }

            // ç”»åƒã®å‡¦ç†: ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°Base64ã«å¤‰æ›ã€ã•ã‚Œã¦ã„ãªã‘ã‚Œã°æ—¢å­˜ã®å€¤ã‚’ä¿æŒ
            const newTicketImage = editTicketImageFile ? await fileToBase64(editTicketImageFile) : liveRecords[recordIndex].ticketImage;
            const newImage = editImageFile ? await fileToBase64(editImageFile) : liveRecords[recordIndex].image;

            // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
            liveRecords[recordIndex] = {
                ...liveRecords[recordIndex],
                date: editDate,
                liveName: editLiveName,
                artist: editArtist,
                venue: editVenue,
                seatType: editSeatType,
                setlist: editSetlist,
                ticketImage: newTicketImage,
                image: newImage,
            };

            saveRecords();
            editMessage.textContent = 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
            editMessage.className = "mt-2 text-sm text-green-600 font-bold";

            // 1ç§’å¾Œã«è©³ç´°è¡¨ç¤ºã«æˆ»ã‚Šã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ›´æ–°
            setTimeout(() => {
                openModal(id);
                populateVenueFilter();
                filterRecords();
            }, 1000);
        };


        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€è©³ç´°ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•° (ç·¨é›†æ©Ÿèƒ½ã®ãƒœã‚¿ãƒ³è¿½åŠ )
        const openModal = (id) => {
            const record = liveRecords.find(r => r.id === id);
            if (!record) return;

            // ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            editButtons.innerHTML = '';
            if (isAuthSuccessful) {
                const editBtn = document.createElement('button');
                editBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm shadow-md';
                editBtn.textContent = 'ç·¨é›†';
                editBtn.onclick = (e) => { e.stopPropagation(); enterEditMode(record.id); };
                editButtons.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm shadow-md';
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.onclick = (e) => { e.stopPropagation(); openDeleteConfirmModal(record.id); };
                editButtons.appendChild(deleteBtn);
            }

            // è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æç”»
            renderDetailContent(record);

            detailModal.classList.remove('hidden');
            setTimeout(() => {
                detailModal.classList.add('opacity-100');
                detailModal.querySelector('.max-w-2xl').classList.replace('scale-95', 'scale-100');
                detailModal.querySelector('.max-w-2xl').classList.replace('opacity-0', 'opacity-100');
            }, 10);

            document.body.style.overflow = 'hidden'; 
        };

        // å‰Šé™¤å‡¦ç†
        const deleteRecord = () => {
            if (recordToDeleteId === null) return;

            const index = liveRecords.findIndex(r => r.id === recordToDeleteId);
            if (index !== -1) {
                liveRecords.splice(index, 1);

                saveRecords(); 
                filterRecords();
                closeModal();
                closeDeleteConfirmModal();
            }
        };

        // ä¼šå ´é¸æŠè‚¢ã‚’å‹•çš„ã«ç”Ÿæˆ
        const populateVenueFilter = () => {
            const venues = liveRecords.map(r => r.venue).filter(Boolean);
            const uniqueVenues = [...new Set(venues)].sort();

            filterVenue.innerHTML = '<option value="">å…¨ã¦ã®ä¼šå ´</option>';
            uniqueVenues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue;
                option.textContent = venue;
                filterVenue.appendChild(option);
            });
        };

        // è¨˜éŒ²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆã—ã¦ä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const filterRecords = () => {
            const keyword = searchKeyword.value.toLowerCase();
            const selectedVenue = filterVenue.value;
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const filteredRecords = liveRecords.filter(record => {
                const matchesKeyword = (
                    record.liveName.toLowerCase().includes(keyword) ||
                    record.artist.toLowerCase().includes(keyword) ||
                    record.venue.toLowerCase().includes(keyword) ||
                    record.seatType.toLowerCase().includes(keyword) ||
                    // setlistä¸­ã®æ›²/ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ¤œç´¢å¯¾è±¡
                    record.setlist.some(item => item.title && item.title.toLowerCase().includes(keyword))
                );

                const matchesVenue = !selectedVenue || record.venue === selectedVenue;

                return matchesKeyword && matchesVenue;
            }).sort((a, b) => new Date(a.date) - new Date(b.date)); // æ—¥ä»˜ã§æ˜‡é †ã‚½ãƒ¼ãƒˆ

            upcomingList.innerHTML = '';
            pastList.innerHTML = '';
            let upcomingCount = 0;
            let pastCount = 0;

            filteredRecords.forEach(record => {
                const liveDate = new Date(record.date);
                const isUpcoming = liveDate >= now;

                const list = isUpcoming ? upcomingList : pastList;
                if (isUpcoming) upcomingCount++; else pastCount++;

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer overflow-hidden transform hover:scale-[1.01] ${isUpcoming ? 'border-t-4 border-blue-500' : 'border-t-4 border-gray-400'}`;
                card.onclick = () => openModal(record.id);

                const dateParts = record.date.split('-');
                const monthDay = `${dateParts[1]}/${dateParts[2]}`;
                const year = dateParts[0];

                card.innerHTML = `
                    <div class="relative h-40">
                        <img src="${record.image || record.ticketImage || `https://placehold.co/600x400/e5e7eb/737373?text=${encodeURIComponent(record.artist)}`}" 
                             alt="ãƒ©ã‚¤ãƒ–ç”»åƒ" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null; this.src='https://placehold.co/600x400/e5e7eb/737373?text=${encodeURIComponent(record.artist)}'">
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/70 to-transparent"></div>
                        <div class="absolute top-0 right-0 m-2 bg-white/90 text-gray-800 text-sm font-bold py-1 px-3 rounded-full shadow-md">
                            ${isUpcoming ? 'äºˆå®š' : 'çµ‚äº†'}
                        </div>
                    </div>
                    <div class="p-4">
                        <p class="text-xs text-gray-500">${year}</p>
                        <p class="text-2xl font-extrabold text-blue-600 mb-1">${monthDay}</p>
                        <h3 class="text-xl font-bold text-gray-900 truncate">${record.liveName}</h3>
                        <p class="text-sm text-gray-600 truncate">${record.artist} @ ${record.venue}</p>
                    </div>
                `;
                list.appendChild(card);
            });

            // çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            const hasResults = upcomingCount > 0 || pastCount > 0;
            document.getElementById('noResults').classList.toggle('hidden', hasResults);
            upcomingList.classList.toggle('hidden', upcomingCount === 0 && !document.getElementById('noResults').classList.contains('hidden'));
            pastList.classList.toggle('hidden', pastCount === 0 && !document.getElementById('noResults').classList.contains('hidden'));
            document.getElementById('upcomingTitle').classList.toggle('hidden', upcomingCount === 0);
            document.getElementById('pastTitle').classList.toggle('hidden', pastCount === 0);
        };

        // --- èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ ---
        authenticateBtn.addEventListener('click', async () => {
            if (checkLockout()) return;

            const password = passwordInput.value;
            if (!password) {
                authMessage.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                authMessage.className = "mt-2 text-sm text-red-500";
                return;
            }

            try {
                const inputHash = await sha256(password);
                if (inputHash === CORRECT_PASSWORD_HASH) {
                    isAuthSuccessful = true;
                    authMessage.textContent = 'èªè¨¼æˆåŠŸï¼ãƒ©ã‚¤ãƒ–ã®è¿½åŠ ãƒ»ç·¨é›†ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚';
                    authMessage.className = "mt-2 text-sm text-green-600 font-bold";
                    authArea.classList.add('hidden');
                    addRecordForm.classList.remove('hidden');

                    // æˆåŠŸæ™‚ã¯è©¦è¡Œå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    localStorage.removeItem('authAttempts');
                    localStorage.removeItem('lockoutEnd');

                    // èªè¨¼å¾Œã€ä¸€è¦§ã‚’æ›´æ–°ã—ã¦ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºå¯èƒ½ã«ã™ã‚‹
                    filterRecords();

                    // æ–°è¦è¿½åŠ ç”¨ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®åˆæœŸåŒ–
                    addSetlistArea.innerHTML = renderSetlistEditor([], 'add');

                } else {
                    let attempts = parseInt(localStorage.getItem('authAttempts') || '0');
                    attempts++;
                    localStorage.setItem('authAttempts', attempts);

                    if (attempts >= MAX_ATTEMPTS) {
                        localStorage.setItem('lockoutEnd', Date.now() + LOCKOUT_DURATION_MS);
                        checkLockout(); // ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    } else {
                        authMessage.textContent = `èªè¨¼å¤±æ•—ã€‚æ®‹ã‚Š ${MAX_ATTEMPTS - attempts} å›ã§ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚`;
                        authMessage.className = "mt-2 text-sm text-red-500";
                    }
                    passwordInput.value = '';
                }
            } catch (error) {
                console.error("Hashing error:", error);
                authMessage.textContent = 'èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                authMessage.className = "mt-2 text-sm text-red-500";
            }
        });

        // --- ãƒ©ã‚¤ãƒ–è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        addRecordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthSuccessful) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const newDate = document.getElementById('newDate').value;
            const newLiveName = document.getElementById('newLiveName').value;
            const newArtist = document.getElementById('newArtist').value;
            const newVenue = document.getElementById('newVenue').value;
            const newSeatType = document.getElementById('newSeatType').value;

            // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ (æ–°è¦è¿½åŠ ç”¨ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰)
            const setlistContainer = document.getElementById('addSetlistEditorContainer');
            const setlistItems = setlistContainer ? setlistContainer.querySelectorAll('.setlist-item') : [];
            const newSetlist = Array.from(setlistItems).map(item => {
                const input = item.querySelector('.setlist-song-input');
                const title = input ? input.value.trim() : '';
                const isSection = input && input.classList.contains('font-bold');
                return isSection ? { type: 'section', title } : { type: 'song', title };
            }).filter(i => i.title && i.title.length > 0);

            const newTicketImageFile = document.getElementById('newTicketImageFile').files[0];
            const newImageFile = document.getElementById('newImageFile').files[0];

            if (!newDate || !newLiveName || !newArtist || !newVenue) {
                addMessage.textContent = 'æ—¥ä»˜ã€ãƒ©ã‚¤ãƒ–åã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã€ä¼šå ´åã¯å¿…é ˆã§ã™ã€‚';
                addMessage.className = "mt-2 text-sm text-red-600 font-bold";
                return;
            }

            const newTicketImage = await fileToBase64(newTicketImageFile);
            const newImage = await fileToBase64(newImageFile);

            const newRecord = {
                id: Date.now(),
                date: newDate,
                liveName: newLiveName,
                artist: newArtist,
                venue: newVenue,
                image: newImage,
                ticketImage: newTicketImage,
                seatType: newSeatType,
                setlist: newSetlist
            };

            liveRecords.push(newRecord);

            saveRecords(); 

            addRecordForm.reset();
            // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆ
            addSetlistArea.innerHTML = renderSetlistEditor([], 'add');

            addMessage.textContent = `ã€Œ${newLiveName}ã€ã®äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`;
            addMessage.className = "mt-2 text-sm text-green-600 font-bold";

            populateVenueFilter();
            filterRecords();
        });


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        searchKeyword.addEventListener('input', filterRecords);
        filterVenue.addEventListener('change', filterRecords);
        confirmDeleteBtn.addEventListener('click', deleteRecord);

        // ãƒ©ã‚¤ãƒ–è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        toggleAddFormBtn.addEventListener('click', () => {
            addRecordSection.classList.toggle('hidden');
            // éè¡¨ç¤ºã«ã™ã‚‹éš›ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            if (addRecordSection.classList.contains('hidden')) {
                authMessage.textContent = '';
                addMessage.textContent = '';
            }
            // èªè¨¼ã‚¨ãƒªã‚¢ãŒéè¡¨ç¤ºãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚‚ãƒªã‚»ãƒƒãƒˆ
            if (isAuthSuccessful) {
                addRecordForm.reset();
                addSetlistArea.innerHTML = renderSetlistEditor([], 'add');
            }
        });

        // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        toggleFilterBtn.addEventListener('click', () => {
            filterArea.classList.toggle('hidden');
        });


        // --- åˆæœŸåŒ–å‡¦ç† ---
        window.onload = () => {
            // ãƒ¢ãƒã‚¤ãƒ«ã§ã®åˆæœŸè¡¨ç¤ºåˆ¶å¾¡
            if (window.innerWidth < 768) {
                filterArea.classList.add('hidden');
            }
            populateVenueFilter();
            filterRecords(); 
            checkLockout();

            // èªè¨¼æ¸ˆã¿ã§ã‚ã‚Œã°è¿½åŠ ç”¨ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
            if (isAuthSuccessful) {
                addSetlistArea.innerHTML = renderSetlistEditor([], 'add');
            }
        };

    </script>

</body>
</html>

