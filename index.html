<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ–è¨˜éŒ² - Live Memo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .auth-hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen text-gray-800">

<header class="bg-gray-800 text-white shadow-lg sticky top-0 z-10">
    <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
        <h1 class="text-2xl font-extrabold tracking-tight cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">ğŸ¶ My Live Records</h1>
        <div class="flex items-center space-x-3">
            <button id="toggleAddForm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-colors text-sm">
                ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </button>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition-colors text-sm hidden">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
            <button id="toggleFilter" class="p-2 rounded-lg hover:bg-gray-700 transition-colors md:hidden text-sm">
                ğŸ”
            </button>
        </div>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4">

    <div id="addRecordSection" class="bg-white p-6 rounded-xl shadow-2xl mb-8 hidden border-l-4 border-blue-500">
        <div id="loginContainer">
            <h2 class="text-xl font-bold text-gray-800 mb-2">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p class="text-sm text-gray-500 mb-4">ç·¨é›†ãƒ»è¿½åŠ ã‚’è¡Œã†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input id="loginEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input id="loginPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg transition-colors">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <p id="loginMessage" class="mt-3 text-sm text-red-500 font-bold text-center"></p>
            </form>
        </div>

        <div id="authContent" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¿½åŠ </h2>
                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>
            </div>

            <form id="addRecordForm">
                <div class="mb-5">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒª *</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center cursor-pointer p-2 border rounded hover:bg-gray-50">
                            <input type="radio" name="newType" value="live" checked class="w-5 h-5 text-blue-600">
                            <span class="ml-2 font-bold">ğŸ¤ ãƒ©ã‚¤ãƒ–</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer p-2 border rounded hover:bg-gray-50">
                            <input type="radio" name="newType" value="event" class="w-5 h-5 text-orange-500">
                            <span class="ml-2 font-bold">ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer p-2 border rounded hover:bg-gray-50">
                            <input type="radio" name="newType" value="other" class="w-5 h-5 text-green-500">
                            <span class="ml-2 font-bold">ğŸ¸ ãã®ä»–</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">æ—¥ä»˜ *</label>
                        <input id="newDate" type="date" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                        <input id="newLiveName" type="text" placeholder="ãƒ„ã‚¢ãƒ¼åãªã©" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ *</label>
                        <input id="newArtist" type="text" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ãƒ©ã‚¤ãƒ–ç¨®åˆ¥</label>
                        <select id="newLiveType" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer">
                            <option value="ãƒ¯ãƒ³ãƒãƒ³">ãƒ¯ãƒ³ãƒãƒ³</option>
                            <option value="å¯¾ãƒãƒ³">å¯¾ãƒãƒ³</option>
                            <option value="ãƒ•ã‚§ã‚¹">ãƒ•ã‚§ã‚¹</option>
                            <option value="ãƒªãƒªã‚¤ãƒ™">ãƒªãƒªã‚¤ãƒ™</option>
                            <option value="ç‰¹å…¸ä¼š">ç‰¹å…¸ä¼š</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ä¼šå ´ *</label>
                        <input id="newVenue" type="text" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">åº§å¸­ / æ•´ç†ç•ªå·</label>
                        <input id="newSeatType" type="text" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">é–¢é€£URL (å…¬å¼ã€ãƒ¬ãƒãªã©)</label>
                    <input id="newUrl" type="url" placeholder="https://..." class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ãƒã‚±ãƒƒãƒˆç”»åƒ</label>
                        <input id="newTicketImageFile" type="file" accept="image/*" class="w-full p-2 border rounded-lg bg-gray-50 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ãƒ©ã‚¤ãƒ–ç”»åƒ</label>
                        <input id="newImageFile" type="file" accept="image/*" class="w-full p-2 border rounded-lg bg-gray-50 text-sm">
                    </div>
                </div>

                <div id="addSetlistArea" class="mb-6"></div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-[1.01]">
                    äºˆå®šã‚’ç™»éŒ²
                </button>
                <p id="addMessage" class="mt-3 text-center text-sm font-bold"></p>
            </form>
        </div>
    </div>

    <div id="filterArea" class="bg-white p-4 rounded-xl shadow-md mb-8 hidden md:block">
        <h2 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">Search & Filter</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <input type="text" id="searchKeyword" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (æ›²å, ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ...)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-full">
            <select id="filterVenue" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-full cursor-pointer">
                <option value="">ğŸ  å…¨ã¦ã®ä¼šå ´</option>
            </select>
        </div>
    </div>

    <h2 id="upcomingTitle" class="text-2xl font-bold text-gray-700 mb-4 mt-2 border-b-4 border-blue-500 pb-2 inline-block">ğŸ“… Upcoming Schedule</h2>
    <section id="upcomingList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12"></section>

    <h2 id="pastTitle" class="text-2xl font-bold text-gray-700 mb-4 border-b-4 border-gray-400 pb-2 inline-block">ğŸ¤ Past Schedule</h2>
    <section id="pastList" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12"></section>

    <div id="noResults" class="hidden text-center p-12 bg-white rounded-xl shadow-sm mt-6">
        <p class="text-xl text-gray-500 font-medium">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>

</main>

<div id="detailModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300" onclick="closeModal(event)">
    <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl overflow-y-auto transform scale-95 opacity-0 transition-all duration-300 flex flex-col" onclick="event.stopPropagation()">
        <div class="p-6 flex-grow">
            <div class="flex justify-between items-start mb-4">
                <div id="editButtons" class="flex space-x-2"></div>
                <button class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors" onclick="closeModal()">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[60] flex items-center justify-center p-4 hidden">
    <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-bounce-in">
        <h3 class="text-xl font-bold text-red-600 mb-3">ğŸš¨ å‰Šé™¤ç¢ºèª</h3>
        <p class="mb-6 text-gray-700">æœ¬å½“ã«ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br><span class="text-sm text-gray-500">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</span></p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-md">å‰Šé™¤å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBDA4-gNmZzTdUkGQdDhesr2-yP9cfdHMw",
  authDomain: "livememo-219c5.firebaseapp.com",
  projectId: "livememo-219c5",
  storageBucket: "livememo-219c5.firebasestorage.app",
  messagingSenderId: "430429863654",
  appId: "1:430429863654:web:45002f94171dd95d4ac527",
  measurementId: "G-JKQBLYY5JP"
};

if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();
const analytics = firebase.analytics();

let liveRecords = [];
let unsubscribe = null;
let recordToDeleteId = null;
let isUserLoggedIn = false;

// ãƒ©ã‚¤ãƒ–ç¨®åˆ¥ã®é¸æŠè‚¢ãƒªã‚¹ãƒˆ
const liveTypeOptions = ["ãƒ¯ãƒ³ãƒãƒ³", "å¯¾ãƒãƒ³", "ãƒ•ã‚§ã‚¹", "ãƒªãƒªã‚¤ãƒ™", "ç‰¹å…¸ä¼š", "ãã®ä»–"];

const dom = {
    addSection: document.getElementById('addRecordSection'),
    toggleAddBtn: document.getElementById('toggleAddForm'),
    loginContainer: document.getElementById('loginContainer'),
    authContent: document.getElementById('authContent'),
    logoutBtn: document.getElementById('logoutBtn'),
    addForm: document.getElementById('addRecordForm'),
    addMsg: document.getElementById('addMessage'),
    addSetlistArea: document.getElementById('addSetlistArea'),
    upcomingList: document.getElementById('upcomingList'),
    pastList: document.getElementById('pastList'),
    searchKeyword: document.getElementById('searchKeyword'),
    filterVenue: document.getElementById('filterVenue'),
    filterArea: document.getElementById('filterArea'),
    toggleFilterBtn: document.getElementById('toggleFilter'),
    detailModal: document.getElementById('detailModal'),
    modalContent: document.getElementById('modalContent'),
    editButtons: document.getElementById('editButtons'),
    deleteModal: document.getElementById('deleteConfirmModal'),
    confirmDeleteBtn: document.getElementById('confirmDeleteBtn')
};

auth.onAuthStateChanged(user => {
    isUserLoggedIn = !!user;
    updateAuthUI(user);
    filterRecords(); 
});

function updateAuthUI(user) {
    if (user) {
        dom.logoutBtn.classList.remove('hidden');
        dom.loginContainer.classList.add('hidden');
        dom.authContent.classList.remove('hidden');
        dom.toggleAddBtn.textContent = "ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â–¼";
        if (dom.addSetlistArea.innerHTML === "") {
            dom.addSetlistArea.innerHTML = renderSetlistEditor([], 'add');
        }
    } else {
        dom.logoutBtn.classList.add('hidden');
        dom.loginContainer.classList.remove('hidden');
        dom.authContent.classList.add('hidden');
        dom.toggleAddBtn.textContent = "ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³";
    }
}

window.handleLogin = (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email, pass)
        .then(() => { analytics.logEvent('login', { method: 'email' }); })
        .catch(err => { document.getElementById('loginMessage').textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; });
};

dom.logoutBtn.addEventListener('click', () => {
    if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")){ auth.signOut().then(() => dom.addSection.classList.add('hidden')); }
});

function startRealtimeListener() {
    if (unsubscribe) unsubscribe();
    unsubscribe = db.collection('liveRecords').orderBy('date').onSnapshot(snapshot => {
        liveRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateVenueFilter();
        filterRecords();
    });
}

async function uploadImageFile(file) {
    if (!file) return '';
    try {
        const path = `images/${Date.now()}_${file.name}`;
        const ref = storage.ref().child(path);
        await ref.put(file);
        return await ref.getDownloadURL();
    } catch(e) { return ''; }
}

const renderSetlistEditor = (setlist, mode) => {
    const containerId = `${mode}SetlistEditorContainer`;
    const inputId = `${mode}NewSongInput`;
    const sectionInputId = `${mode}NewSectionInput`;
    const itemsHtml = (setlist || []).map((item, index) => {
        const isSection = item.type === 'section';
        const numDisplay = isSection ? '-' : `${index + 1}.`;
        const styleClass = isSection ? 'font-bold text-blue-600 bg-blue-50' : 'text-gray-700';
        return `
        <div class="flex items-center space-x-2 mb-2 setlist-item group">
            <span class="text-gray-400 font-bold w-6 text-right text-xs">${numDisplay}</span>
            <input type="text" value="${item.title}" class="flex-grow p-2 border border-gray-300 rounded text-sm ${styleClass} setlist-song-input">
            <input type="hidden" class="setlist-type-input" value="${item.type}">
            <button type="button" onclick="removeSetlistItem(this, '${containerId}')" class="text-red-400 hover:text-red-600 p-2 transition-opacity">âœ–</button>
        </div>`;
    }).join('');

    return `
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm">
        <label class="block font-bold text-gray-700 mb-2">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ / ãƒ¡ãƒ¢</label>
        <div id="${containerId}" class="mb-3">${itemsHtml}</div>
        
        <div class="flex space-x-2 border-b pb-3 border-gray-200 mb-3">
            <input type="text" id="${inputId}" placeholder="æ›²åã‚’å…¥åŠ›" class="flex-grow p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" onkeydown="if(event.key==='Enter'){event.preventDefault(); addSetlistItem('${mode}');}">
            <button type="button" onclick="addSetlistItem('${mode}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold whitespace-nowrap">æ›²ã‚’è¿½åŠ </button>
        </div>

        <div class="flex flex-col gap-2">
            <div class="flex space-x-2">
                <input type="text" id="${sectionInputId}" placeholder="ã‚»ã‚¯ã‚·ãƒ§ãƒ³å (ä¾‹: ç¬¬1éƒ¨, Acoustic)" class="flex-grow p-2 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-teal-500" onkeydown="if(event.key==='Enter'){event.preventDefault(); addCustomSection('${mode}');}">
                <button type="button" onclick="addCustomSection('${mode}')" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-1 rounded font-bold text-xs whitespace-nowrap">åŒºåˆ‡ã‚Šã‚’è¿½åŠ </button>
            </div>
            <div class="flex flex-wrap gap-2">
                <button type="button" onclick="addSection('${mode}', 'ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs">ï¼‹ ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«</button>
                <button type="button" onclick="addSection('${mode}', 'MC')" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">ï¼‹ MC</button>
            </div>
        </div>
    </div>`;
};

window.addSetlistItem = (mode) => {
    const input = document.getElementById(`${mode}NewSongInput`);
    if (!input.value.trim()) return;
    appendItemHTML(mode, input.value.trim(), 'song');
    input.value = ''; input.focus();
};

window.addCustomSection = (mode) => {
    const input = document.getElementById(`${mode}NewSectionInput`);
    if (!input.value.trim()) return;
    appendItemHTML(mode, input.value.trim(), 'section');
    input.value = '';
};

window.addSection = (mode, title) => { appendItemHTML(mode, title, 'section'); };

function appendItemHTML(mode, title, type) {
    const container = document.getElementById(`${mode}SetlistEditorContainer`);
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2 mb-2 setlist-item group';
    div.innerHTML = `<span class="text-gray-400 font-bold w-6 text-right text-xs">-</span>
        <input type="text" value="${title}" class="flex-grow p-2 border border-gray-300 rounded text-sm ${type==='section'?'font-bold text-blue-600 bg-blue-50':''} setlist-song-input">
        <input type="hidden" class="setlist-type-input" value="${type}">
        <button type="button" onclick="removeSetlistItem(this, '${mode}SetlistEditorContainer')" class="text-red-400 hover:text-red-600 p-2">âœ–</button>`;
    container.appendChild(div);
    renumberSetlist(`${mode}SetlistEditorContainer`);
}

window.removeSetlistItem = (btn, containerId) => { btn.closest('.setlist-item').remove(); renumberSetlist(containerId); };

const renumberSetlist = (id) => {
    let songCount = 0;
    document.getElementById(id).querySelectorAll('.setlist-item').forEach(item => {
        const isSong = item.querySelector('.setlist-type-input').value === 'song';
        item.querySelector('span').textContent = isSong ? `${++songCount}.` : '-';
    });
};

const getSetlistData = (mode) => Array.from(document.getElementById(`${mode}SetlistEditorContainer`).querySelectorAll('.setlist-item')).map(item => ({
    title: item.querySelector('.setlist-song-input').value.trim(),
    type: item.querySelector('.setlist-type-input').value
})).filter(i => i.title);

dom.addForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isUserLoggedIn) return;
    dom.addMsg.textContent = "é€ä¿¡ä¸­...";
    try {
        const ticketUrl = await uploadImageFile(document.getElementById('newTicketImageFile').files[0]);
        const imageUrl = await uploadImageFile(document.getElementById('newImageFile').files[0]);
        const recordData = {
            type: document.querySelector('input[name="newType"]:checked').value,
            date: document.getElementById('newDate').value,
            liveName: document.getElementById('newLiveName').value.trim(),
            artist: document.getElementById('newArtist').value.trim(),
            liveType: document.getElementById('newLiveType').value,
            venue: document.getElementById('newVenue').value.trim(),
            url: document.getElementById('newUrl').value.trim(),
            seatType: document.getElementById('newSeatType').value,
            image: imageUrl,
            ticketImage: ticketUrl,
            setlist: getSetlistData('add'),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('liveRecords').add(recordData);
        dom.addForm.reset();
        dom.addSetlistArea.innerHTML = renderSetlistEditor([], 'add');
        dom.addMsg.textContent = "âœ… è¿½åŠ å®Œäº†ï¼";
        setTimeout(() => dom.addMsg.textContent = "", 3000);
    } catch(err) { dom.addMsg.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message; }
});

window.openModal = (id) => {
    const record = liveRecords.find(r => r.id === id);
    if (!record) return;
    renderDetailView(record);
    dom.detailModal.classList.remove('hidden');
    setTimeout(() => {
        dom.detailModal.classList.add('opacity-100');
        dom.detailModal.querySelector('.max-w-2xl').classList.replace('scale-95', 'scale-100');
        dom.detailModal.querySelector('.max-w-2xl').classList.replace('opacity-0', 'opacity-100');
    }, 10);
    document.body.style.overflow = 'hidden';
};

function renderDetailView(record) {
    dom.editButtons.innerHTML = isUserLoggedIn ? `<button onclick="enterEditMode('${record.id}')" class="bg-yellow-500 text-white text-sm font-bold py-2 px-4 rounded shadow">ç·¨é›†</button><button onclick="openDeleteConfirmModal('${record.id}')" class="bg-red-500 text-white text-sm font-bold py-2 px-4 rounded shadow">å‰Šé™¤</button>` : '';
    
    const urlButton = record.url ? `<div class="mb-6"><a href="${record.url}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full bg-blue-50 hover:bg-blue-100 text-blue-700 font-bold py-3 px-4 rounded-lg border border-blue-200 transition-colors">ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯ / å…¬å¼ã‚µã‚¤ãƒˆ</a></div>` : '';

    let setlistHtml = '';
    if (record.setlist && record.setlist.length > 0) {
        let count = 0;
        setlistHtml = `<div class="mt-6 pt-4 border-t border-gray-200"><h3 class="font-bold text-gray-700 mb-3">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ / ãƒ¡ãƒ¢</h3><ul class="space-y-2 text-sm">${record.setlist.map(item => {
            if(item.type === 'section') return `<li class="font-bold text-blue-600 mt-4 border-b border-blue-100 pb-1 flex items-center"><span class="mr-2">â–¼</span>${item.title}</li>`;
            return `<li class="flex"><span class="w-6 text-gray-400 text-right mr-2">${++count}.</span><span class="text-gray-800">${item.title}</span></li>`;
        }).join('')}</ul></div>`;
    }

    dom.modalContent.innerHTML = `
        <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">${record.type.toUpperCase()}</span>
                ${record.liveType ? `<span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">${record.liveType}</span>` : ''}
                <span class="text-gray-500 text-sm ml-auto">${record.date}</span>
            </div>
            <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 leading-tight mt-2">${record.liveName}</h2>
            <p class="text-xl text-blue-600 font-semibold">${record.artist}</p>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500 font-bold">VENUE</p><p class="font-medium">${record.venue}</p></div>
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500 font-bold">SEAT</p><p class="font-medium">${record.seatType || '-'}</p></div>
        </div>
        ${urlButton}
        ${record.image ? `<img src="${record.image}" class="w-full rounded-lg shadow mb-4 object-cover max-h-96">` : ''}
        ${record.ticketImage ? `<div class="mb-4"><p class="text-xs font-bold text-gray-500 mb-1">TICKET</p><img src="${record.ticketImage}" class="w-full rounded-lg shadow border object-cover max-h-60"></div>` : ''}
        ${setlistHtml}
    `;
}

window.enterEditMode = (id) => {
    const record = liveRecords.find(r => r.id === id);
    dom.editButtons.innerHTML = '';
    
    // ç·¨é›†ç”»é¢ç”¨ã®ãƒ©ã‚¤ãƒ–ç¨®åˆ¥é¸æŠè‚¢ã‚’ç”Ÿæˆ
    const optionsHtml = liveTypeOptions.map(opt => `<option value="${opt}" ${record.liveType === opt ? 'selected' : ''}>${opt}</option>`).join('');

    dom.modalContent.innerHTML = `<h2 class="text-xl font-bold mb-4 border-b pb-2">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</h2>
        <form onsubmit="event.preventDefault(); saveEditedRecord('${record.id}');">
            <div class="mb-4"><label class="block text-sm font-bold text-gray-700">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="editLiveName" value="${record.liveName}" class="w-full p-2 border rounded"></div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div><label class="block text-sm font-bold text-gray-700">æ—¥ä»˜</label><input type="date" id="editDate" value="${record.date}" class="w-full p-2 border rounded"></div>
                <div><label class="block text-sm font-bold text-gray-700">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label><input id="editArtist" value="${record.artist}" class="w-full p-2 border rounded"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700">ãƒ©ã‚¤ãƒ–ç¨®åˆ¥</label>
                    <select id="editLiveType" class="w-full p-2 border rounded bg-white">${optionsHtml}</select>
                </div>
                <div><label class="block text-sm font-bold text-gray-700">ä¼šå ´</label><input id="editVenue" value="${record.venue}" class="w-full p-2 border rounded"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div><label class="block text-sm font-bold text-gray-700">åº§å¸­</label><input id="editSeatType" value="${record.seatType||''}" class="w-full p-2 border rounded"></div>
                <div><label class="block text-sm font-bold text-gray-700">é–¢é€£URL</label><input id="editUrl" type="url" value="${record.url||''}" class="w-full p-2 border rounded"></div>
            </div>
            <div class="mb-4 text-sm bg-gray-50 p-3 rounded">
                <p class="font-bold mb-1">ç”»åƒæ›´æ–° (ç©ºæ¬„ãªã‚‰ç¶­æŒ)</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input id="editImageFile" type="file" accept="image/*" class="w-full">
                    <input id="editTicketImageFile" type="file" accept="image/*" class="w-full">
                </div>
            </div>
            <div class="mb-6">${renderSetlistEditor(record.setlist, 'edit')}</div>
            <div class="flex space-x-3"><button class="flex-1 bg-blue-600 text-white font-bold py-2 rounded">ä¿å­˜</button><button type="button" onclick="openModal('${record.id}')" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 rounded">ä¸­æ­¢</button></div>
            <p id="editMessage" class="text-center text-sm mt-2 font-bold"></p>
        </form>`;
};

window.saveEditedRecord = async (id) => {
    const editMsg = document.getElementById('editMessage');
    editMsg.textContent = "ä¿å­˜ä¸­...";
    try {
        const record = liveRecords.find(r => r.id === id);
        const imageFile = document.getElementById('editImageFile').files[0];
        const ticketFile = document.getElementById('editTicketImageFile').files[0];
        const updatedData = {
            liveName: document.getElementById('editLiveName').value.trim(),
            date: document.getElementById('editDate').value,
            artist: document.getElementById('editArtist').value.trim(),
            liveType: document.getElementById('editLiveType').value,
            venue: document.getElementById('editVenue').value.trim(),
            seatType: document.getElementById('editSeatType').value,
            url: document.getElementById('editUrl').value.trim(),
            setlist: getSetlistData('edit'),
            image: imageFile ? await uploadImageFile(imageFile) : record.image,
            ticketImage: ticketFile ? await uploadImageFile(ticketFile) : record.ticketImage
        };
        await db.collection('liveRecords').doc(id).update(updatedData);
        openModal(id);
    } catch (e) { editMsg.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message; }
};

window.closeModal = (e) => {
    if (e && e.target !== dom.detailModal) return;
    dom.detailModal.classList.remove('opacity-100');
    dom.detailModal.querySelector('.max-w-2xl').classList.replace('scale-100', 'scale-95');
    setTimeout(() => { dom.detailModal.classList.add('hidden'); document.body.style.overflow = ''; }, 300);
};

window.openDeleteConfirmModal = (id) => { recordToDeleteId = id; dom.deleteModal.classList.remove('hidden'); };
window.closeDeleteConfirmModal = () => { recordToDeleteId = null; dom.deleteModal.classList.add('hidden'); };
dom.confirmDeleteBtn.addEventListener('click', async () => {
    if (recordToDeleteId) { await db.collection('liveRecords').doc(recordToDeleteId).delete(); closeDeleteConfirmModal(); closeModal(); }
});

function populateVenueFilter() {
    const venues = [...new Set(liveRecords.map(r => r.venue).filter(Boolean))].sort();
    dom.filterVenue.innerHTML = '<option value="">ğŸ  å…¨ã¦ã®ä¼šå ´</option>' + venues.map(v => `<option value="${v}">${v}</option>`).join('');
}

function filterRecords() {
    const keyword = dom.searchKeyword.value.toLowerCase();
    const venueFilter = dom.filterVenue.value;
    const now = new Date(); now.setHours(0,0,0,0);
    
    const filtered = liveRecords.filter(r => {
        const textMatch = [r.liveName, r.artist, r.venue, r.liveType || ''].some(txt => txt.toLowerCase().includes(keyword)) || (r.setlist || []).some(s => s.title.toLowerCase().includes(keyword));
        return textMatch && (!venueFilter || r.venue === venueFilter);
    }).sort((a,b) => new Date(a.date) - new Date(b.date));
    
    dom.upcomingList.innerHTML = ''; dom.pastList.innerHTML = '';
    filtered.forEach(rec => {
        const isUpcoming = new Date(rec.date) >= now;
        const dateStr = rec.date.split('-');
        const el = document.createElement('div');
        el.className = `bg-white rounded-xl shadow p-5 cursor-pointer transform hover:-translate-y-1 transition-all border-t-4 ${isUpcoming?'border-blue-500':'border-gray-400 opacity-90'}`;
        el.onclick = () => openModal(rec.id);
        el.innerHTML = `<div class="flex justify-between text-xs font-bold mb-2">
                <div class="flex gap-1">
                    <span class="px-2 py-1 rounded bg-blue-100 text-blue-800">${rec.type.toUpperCase()}</span>
                    ${rec.liveType ? `<span class="px-2 py-1 rounded bg-gray-100 text-gray-600">${rec.liveType}</span>` : ''}
                </div>
                <span class="text-gray-400 font-mono">${dateStr[0]}</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900 leading-tight mb-1 line-clamp-2">${rec.liveName}</h3>
            <div class="text-2xl font-extrabold text-gray-700 mb-2">${dateStr[1]}/${dateStr[2]}</div>
            <div class="flex items-center text-sm text-gray-500 truncate"><span class="text-blue-600 font-semibold mr-1">${rec.artist}</span> @ ${rec.venue}</div>`;
        (isUpcoming ? dom.upcomingList : dom.pastList).appendChild(el);
    });
    
    const pastItems = Array.from(dom.pastList.children).reverse();
    dom.pastList.innerHTML = '';
    pastItems.forEach(i => dom.pastList.appendChild(i));
    
    document.getElementById('noResults').classList.toggle('hidden', filtered.length > 0);
}

dom.toggleAddBtn.addEventListener('click', () => { dom.addSection.classList.toggle('hidden'); window.scrollTo({top:0, behavior:'smooth'}); });
dom.toggleFilterBtn.addEventListener('click', () => dom.filterArea.classList.toggle('hidden'));
dom.searchKeyword.addEventListener('input', filterRecords);
dom.filterVenue.addEventListener('change', filterRecords);
window.onload = startRealtimeListener;
</script>
</body>
</html>
